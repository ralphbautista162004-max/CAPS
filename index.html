<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IVMS</title>
  <!-- Google Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Feather icons -->
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <style>
    :root{ --bg:#f8fafc; --muted:#6b7280; --accent:#2563eb; --card:#ffffff; --sidebar:#f1f5f9; --sidebar-accent:#2563eb; --text:#111827; --sidebar-text:#111827; --sidebar-muted:#6b7280; --sidebar-light:#374151; --sidebar-subtitle:#6b7280; --sidebar-hover:#e2e8f0; --sidebar-active:#cbd5e1; --input-bg:#ffffff; --input-border:#e6e6e6; --success:#10b981; --warning:#f59e0b; --danger:#ef4444; --radius:12px; }
    .dark{ --bg:#0f172a; --muted:#cbd5e1; --accent:#60a5fa; --card:#1e293b; --sidebar:#1e293b; --sidebar-accent:#60a5fa; --text:#f8fafc; --sidebar-text:#f8fafc; --sidebar-muted:#cbd5e1; --sidebar-light:#e2e8f0; --sidebar-subtitle:#93c5fd; --sidebar-hover:#334155; --sidebar-active:#475569; --input-bg:#1e293b; --input-border:#475569; --success:#34d399; --warning:#fbbf24; --danger:#f87171; --radius:12px; }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{display:flex;min-height:100vh;background:var(--bg);color:var(--text);line-height:1.35;overflow:hidden;}
    /* Sidebar */
    .sidebar{ 
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width:260px;
      background:var(--sidebar);
      color:var(--sidebar-text);
      padding:20px 18px;
      display:flex;
      flex-direction:column;
      gap:18px;
      transition:left .22s;
      overflow-y: auto;
    }
    /* Main content wrapper */
    .main {
      margin-left: 260px;
      flex: 1;
      overflow-y: auto;
      height: 100vh;
    }
    .brand{display:flex;align-items:center;gap:12px} .logo{font-weight:700;font-size:20px} .logo span{color:var(--sidebar-accent)} .subtitle{font-size:12px;color:var(--sidebar-subtitle)}
    nav{margin-top:6px;flex:1;overflow:auto;padding-right:6px}
    .menu-section{font-size:11px;color:var(--sidebar-muted);margin:10px 0 6px;text-transform:uppercase}
    .menu{list-style:none;display:flex;flex-direction:column;gap:6px}
    .menu button{ display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;border:0;background:transparent;color:var(--sidebar-light);cursor:pointer;text-align:left; }
    .menu button:hover{background:var(--sidebar-hover);color:var(--sidebar-text)}
    .menu button.active{background:var(--sidebar-active);box-shadow:inset 0 0 0 2px rgba(255,255,255,0.02);color:var(--sidebar-text)}
    .menu .icon{width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;opacity:0.9}
    .user{display:flex;flex-direction:column;align-items:center;gap:10px;padding:10px;border-top:1px solid var(--input-border);position:fixed;bottom:0;left:0;width:260px;background:var(--sidebar)}
    .avatar{width:38px;height:38px;border-radius:8px;background:var(--sidebar-accent);display:flex;align-items:center;justify-content:center;font-weight:700}
    .uinfo .name{font-size:14px} .uinfo .role{font-size:12px;color:var(--sidebar-muted)}
    #userBtn { color: var(--sidebar-light); }
    #userBtn:hover { color: var(--sidebar-text); }
    /* Theme Toggle Switch */
    .theme-toggle-container{margin:18px 0 6px}
    .theme-switch{display:flex;align-items:center;justify-content:space-between;padding:10px 18px}
    .theme-label{font-size:13px;color:var(--sidebar-light)}
    .switch{position:relative;display:inline-block;width:44px;height:24px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--sidebar-muted);transition:.3s;border-radius:24px}
    .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:var(--sidebar-text);transition:.3s;border-radius:50%}
    input:checked + .slider{background-color:var(--sidebar-accent)}
    input:checked + .slider:before{transform:translateX(20px)}
    /* Main */
    .main{flex:1;padding:24px;overflow:auto}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    header h1{font-size:20px}
    header .controls{display:flex;gap:10px;align-items:center}
    .search{padding:8px 12px;border-radius:10px;border:1px solid var(--input-border);background:var(--input-bg);min-width:220px;color:var(--text)}
    /* Cards */
    .cards{display:flex;flex-direction:column;gap:16px;margin-bottom:18px}
    .cards-row{display:flex;gap:16px}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.04)}
    .card h3{font-size:13px;color:var(--muted);margin-bottom:8px} .card .value{font-size:20px;font-weight:700} .card .meta{font-size:12px;color:var(--muted);margin-top:6px}
    /* Dashboard grid */
    .grid-two{display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:18px} .panel{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.04)}
    /* Small panels row */
    .row-three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:18px}
    /* Tables */
    table{width:100%;border-collapse:collapse} th,td{padding:10px;text-align:left;border-bottom:1px solid var(--input-border);font-size:13px} th{color:var(--muted);font-weight:600}
    .badge{display:inline-block;padding:6px 9px;border-radius:999px;color:#fff;font-size:12px;font-weight:500}
    .badge.green{background:#10b981}
    .badge.orange{background:#f59e0b}
    .badge.red{background:#ef4444}
    .badge.gray{background:#6b7280}
    /* Buttons */
    .btn{padding:8px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;cursor:pointer} .btn.ghost{background:transparent;border:1px solid var(--input-border);color:var(--text)} .small{padding:6px 8px;font-size:13px;border-radius:8px}
    /* Alerts list */
    .alerts-list{display:flex;flex-direction:column;gap:10px} .alert-row{padding:10px;border-radius:8px;background:var(--card);border-left:6px solid var(--danger);display:flex;justify-content:space-between;align-items:center}
    /* Forms and settings */
    .form-row{display:flex;gap:10px;margin-top:10px} .input{padding:10px;border-radius:8px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);min-width:0}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:60}
    .modal{width:1000px;max-width:96%;background:var(--card);border-radius:12px;padding:24px;box-shadow:0 20px 50px rgba(2,6,23,0.3)} .modal h3{margin-bottom:8px} .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    /* Responsive */
    @media (max-width:900px){ .grid-two{grid-template-columns:1fr} .sidebar{position:fixed;left:-100%;top:0;height:100%;z-index:80;transition:left .25s} .sidebar.open{left:0} .main{padding:14px} .toggle-sidebar{display:inline-flex;} }
    .toggle-sidebar{display:none;background:transparent;border:0;color:var(--text);cursor:pointer}
    /* tiny helpers for table actions */
    td .actions { display:flex; gap:8px; justify-content:flex-end; }
    /* Transactions page (full table) column tweaks */
    #transactionsTableFull th:nth-child(1), #transactionsTableFull td:nth-child(1){ width:100px; white-space:nowrap }
    #transactionsTableFull th:nth-child(2), #transactionsTableFull td:nth-child(2){ width:140px; white-space:nowrap }
    #transactionsTableFull th:nth-child(3), #transactionsTableFull td:nth-child(3){ width:120px; white-space:nowrap }
    #transactionsTableFull th:nth-child(4), #transactionsTableFull td:nth-child(4){ max-width:520px }
    #transactionsTableFull th:nth-child(5), #transactionsTableFull td:nth-child(5){ width:80px; text-align:right; white-space:nowrap }
    #transactionsTableFull th:nth-child(6), #transactionsTableFull td:nth-child(6){ width:100px; text-align:right; white-space:nowrap }
    #transactionsTableFull th:nth-child(7), #transactionsTableFull td:nth-child(7){ width:100px; text-align:right; white-space:nowrap }
    #transactionsTableFull th:nth-child(8), #transactionsTableFull td:nth-child(8){ width:120px; text-align:left; white-space:nowrap }
    #transactionsTableFull th:nth-child(9), #transactionsTableFull td:nth-child(9){ width:120px; text-align:right; white-space:nowrap }
    /* Materials Records table column tweaks */
    #materialsTable2 th:nth-child(1), #materialsTable2 td:nth-child(1){ width:100px; white-space:nowrap }
    #materialsTable2 th:nth-child(2), #materialsTable2 td:nth-child(2){ max-width:520px }
    #materialsTable2 th:nth-child(3), #materialsTable2 td:nth-child(3){ width:80px; text-align:right; white-space:nowrap }
    #materialsTable2 th:nth-child(4), #materialsTable2 td:nth-child(4){ width:80px; text-align:right; white-space:nowrap }
    #materialsTable2 th:nth-child(5), #materialsTable2 td:nth-child(5){ width:100px; text-align:right; white-space:nowrap }
    #materialsTable2 th:nth-child(6), #materialsTable2 td:nth-child(6){ width:120px; text-align:center; white-space:nowrap }
    #materialsTable2 th:nth-child(7), #materialsTable2 td:nth-child(7){ width:120px; text-align:right; white-space:nowrap }
    #materialsTable2 th:nth-child(8), #materialsTable2 td:nth-child(8){ width:120px; text-align:right; white-space:nowrap }
    /* Inline transactions form ‚Äî responsive grid to avoid horizontal scroll */
    /* Desktop-aligned grid matching transaction columns; collapses at smaller widths */
    /* Match transactions table column widths: Type (100), By (140), SKU (120), Product (flex), QTY (80), Cost (80), Date (120), Actions (auto) */
    #inlineTxnForm { display:grid; grid-template-columns:100px 140px 120px 1fr 80px 80px 120px auto; gap:8px; align-items:end; align-content:start; }
    #inlineTxnForm label{ margin:0; }
    #inlineTxnForm .inline-qty input{ width:72px; }
    #inlineTxnForm .inline-cost input{ width:72px; }
    #inlineTxnForm .inline-actions{ grid-column:1/-1; justify-self:end; display:flex; gap:8px; }
    #inlineTxn{background:var(--card);border-radius:10px;padding:10px;border:1px solid var(--input-border)}
    @media (max-width:900px){ #inlineTxnForm{ grid-template-columns:repeat(3,1fr); } #inlineTxnForm .inline-actions{ justify-self:center; } }
    @media (max-width:520px){ #inlineTxnForm{ grid-template-columns:1fr; } #inlineTxnForm .inline-actions{ justify-self:center; } }
    /* Toast notifications */
    #toastRoot{position:fixed;right:18px;bottom:22px;z-index:120;display:flex;flex-direction:column;gap:8px;max-width:min(420px,calc(100% - 48px));}
    .toast{background:var(--card);color:var(--text);padding:10px 12px;border-radius:10px;box-shadow:0 10px 30px rgba(2,6,23,0.35);display:flex;gap:10px;align-items:center;justify-content:space-between;opacity:0;transform:translateY(10px) scale(0.98);transition:opacity .18s,transform .18s}
    .toast.show{opacity:1;transform:translateY(0) scale(1)}
    .toast .msg{font-size:13px;color:var(--muted)}
    .toast .action{background:transparent;border:0;color:var(--accent);cursor:pointer;padding:6px;border-radius:6px}
    /* Page display styles */
    .page{ padding:24px; overflow:auto; }
    /* Login page full viewport centering */
    #login-page{ width:100vw; height:100vh; background:var(--bg); }
    /* Linear Programming styles */
    #linear-programming-page {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 40px;
      background: var(--bg);
      color: var(--text);
    }
    #linear-programming-page h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    #linear-programming-page p {
      font-size: 16px;
      margin-bottom: 15px;
    }
    #linear-programming-page input[type="number"] {
      width: 80px;
      padding: 5px;
      border: 1px solid var(--input-border);
      border-radius: 4px;
      background: var(--input-bg);
      color: var(--text);
    }
    #linear-programming-page table {
      border-collapse: collapse;
      width: 90%;
      margin: 20px auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      background: var(--card);
    }
    #linear-programming-page th, #linear-programming-page td {
      border: 1px solid var(--input-border);
      padding: 10px;
      text-align: center;
    }
    #linear-programming-page th {
      background: var(--accent);
      color: #fff;
    }
    #linear-programming-page tr:nth-child(even) {
      background: var(--bg);
    }
    #linear-programming-page .result {
      background: #ecf0f1;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      margin: 20px auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .dark #linear-programming-page .result {
      background: var(--card);
    }
    #linear-programming-page button {
      display: block;
      margin: 20px auto;
      padding: 12px 25px;
      background: #27ae60;
      color: #fff;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    #linear-programming-page button:hover {
      background: #219150;
    }
  </style>
</head>
<body>
  <aside class="sidebar" id="sidebar">
    <div>
      <div class="brand">
        <div class="logo">
          <img src="1.png" alt="logo" style="max-height: 40px; width: auto;">
        </div>
      </div>
      <nav>
        <div class="menu-section">Main</div>
        <ul class="menu" id="menu">
          <li><button data-page="dashboard" class="active"><img src="Dash.png" alt="Dashboard" style="width: 18px; height: 18px; margin-right: 10px;"> Dashboard</button></li>
          <li><button data-page="materials"><img src="Material Records.webp" alt="Material Records" style="width: 18px; height: 18px; margin-right: 10px;"> Material Records</button></li>
          <li><button data-page="material-descriptions"><img src="Material Records.webp" alt="Material Descriptions" style="width: 18px; height: 18px; margin-right: 10px;"> Material Descriptions</button></li>
          <li><button data-page="transactions"><img src="Material Transactions.png" alt="Material Transaction" style="width: 18px; height: 18px; margin-right: 10px;"> Material Transaction</button></li>
          <li><button data-page="defects"><img src="Defects Log Reports.jpg" alt="Defects Log Reports" style="width: 18px; height: 18px; margin-right: 10px;"> Defects Log Reports</button></li>
          <li><button data-page="sap-data"><img src="Material Records.webp" alt="SAP Data" style="width: 18px; height: 18px; margin-right: 10px;"> SAP Data</button></li>
          <li><button data-page="comparison"><img src="Settings.webp" alt="Comparison" style="width: 18px; height: 18px; margin-right: 10px;"> Comparison</button></li>
          <li><button data-page="settings"><img src="Settings.webp" alt="Settings" style="width: 18px; height: 18px; margin-right: 10px;"> Settings</button></li>
          <li><button data-page="linear-programming"><img src="Settings.webp" alt="Linear Programming" style="width: 18px; height: 18px; margin-right: 10px;"> Linear Programming</button></li>
        </ul>
      </nav>
      <div class="theme-toggle-container">
        <div class="menu-section">Theme</div>
        <div class="theme-switch">
          <span class="theme-label">Dark Mode</span>
          <label class="switch">
            <input type="checkbox" id="themeToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </div>
    <div class="user">
      <div class="avatar">IV</div>
      <div class="uinfo">
        <div class="name">Invyra</div>
        <div class="role">Admin</div>
      </div>
      <button class="btn ghost small" id="userBtn">Invyra (Admin)</button>
    </div>
  </aside>

  <main class="main">
    <header>
      <div style="display:flex;align-items:center;gap:12px;">
        <button class="toggle-sidebar" id="btnToggle" aria-label="Open sidebar">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 12h18M3 6h18M3 18h18" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <h1 id="pageTitle">Inventory Dashboard</h1>
      </div>
    </header>

    <!-- Pages -->
    <section id="login-page" class="page" style="display:flex;align-items:center;justify-content:center;min-height:100vh">
      <div style="background:var(--card);padding:40px;border-radius:16px;box-shadow:0 10px 40px rgba(15,23,42,0.1);width:100%;max-width:400px">
        <div style="text-align:center;margin-bottom:32px">
          <div style="font-size:48px;margin-bottom:12px">üîê</div>
          <h1 style="font-size:28px;margin:0;margin-bottom:8px">IVMS Login</h1>
          <p style="color:var(--muted);margin:0;font-size:14px">Inventory & Production Management System</p>
        </div>

        <form id="loginForm" style="display:flex;flex-direction:column;gap:16px">
          <div>
            <label style="display:block;font-weight:600;margin-bottom:6px;font-size:14px">Username</label>
            <input 
              type="text" 
              id="loginUsername" 
              class="input" 
              placeholder="Enter your username" 
              style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);font-size:14px"
              required
            />
          </div>

          <div>
            <label style="display:block;font-weight:600;margin-bottom:6px;font-size:14px">Password</label>
            <input 
              type="password" 
              id="loginPassword" 
              class="input" 
              placeholder="Enter your password" 
              style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);font-size:14px"
              required
            />
          </div>

          <div>
            <label style="display:block;font-weight:600;margin-bottom:6px;font-size:14px">Role</label>
            <select 
              id="loginRole" 
              class="input" 
              style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);font-size:14px;cursor:pointer"
              required
            >
              <option value="">Select a role</option>
              <option value="admin">Admin</option>
              <option value="employee">Employee</option>
              <option value="student">Student</option>
            </select>
          </div>

          <button 
            type="submit" 
            class="btn" 
            style="width:100%;padding:12px;margin-top:8px;font-size:14px;font-weight:600;border:0;border-radius:8px;cursor:pointer"
          >
            Sign In
          </button>

          <div style="margin-top:16px;padding:12px;background:rgba(59, 130, 246, 0.1);border-radius:8px;border-left:4px solid var(--accent)">
            <p style="margin:0;font-size:12px;color:var(--muted);line-height:1.4">
              <strong>Demo Credentials:</strong><br>
              Username: admin | Password: demo | Role: Admin
            </p>
          </div>
        </form>

        <div id="loginError" style="margin-top:16px;padding:12px;border-radius:8px;background:rgba(239, 68, 68, 0.1);border-left:4px solid var(--danger);color:var(--danger);display:none;font-size:13px"></div>
      </div>
    </section>

    <section id="dashboard-page" class="page" style="display:none">
      <div class="cards">
        <div class="card total-materials-card">
          <h3>Total Materials Available</h3>
          <div style="margin-bottom:8px;">
            <label style="font-size:13px;color:var(--muted);margin-right:8px">Filter by Item Description:</label>
            <select id="totalMaterialsFilter" class="input" style="width:250px">
              <option value="">All</option>
            </select>
          </div>
          <div class="value" id="materialsReceived">600</div>
          <div class="meta">Available materials adjusted for defects</div>
        </div>
        <div class="cards-row">
          <div class="card">
            <h3>Defects Reported (30d)</h3>
            <div class="value" id="defectsCount">‚Äî</div>
            <div class="meta">Defects reported during the last 30 days</div>
          </div>
          <div class="card">
            <h3>Low Stock Items</h3>
            <div class="value" id="lowStockCount">‚Äî</div>
            <div class="meta">Items below threshold</div>
          </div>
          <div class="card">
            <h3>Out of Stock</h3>
            <div class="value" id="oosCount">‚Äî</div>
            <div class="meta">Completely depleted items</div>
          </div>
        </div>
      </div>

      <div class="grid-two">
        <div class="panel">
          <h3 style="margin-bottom:8px">Stock Movement (30 days)</h3>
          <canvas id="movementChart" height="160" aria-label="Stock Movement Chart"></canvas>
        </div>
        <div class="panel">
          <h3 style="margin-bottom:8px">Low Stock Alerts</h3>
          <div class="alerts-list" id="alertsList"></div>
        </div>
        </div>
      </div>

      <div class="row-two">
        <div class="panel">
          <h3 style="margin-bottom:8px">Inventory Overview</h3>
          <div style="margin-top:10px;overflow:auto;max-height:240px">
            <table id="materialsTable">
              <thead>
                <tr><th>Type</th><th>By</th><th>Item No.</th><th>Item description</th><th>QTY</th><th>Stock Level</th><th>Date</th><th>Actions</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="panel">
          <h3 style="margin-bottom:8px">Recent Transactions</h3>
          <div style="margin-top:10px;overflow:auto;max-height:240px">
            <table id="transactionsTable">
              <thead>
                <!-- align short dashboard view with full transactions columns (compact) -->
                <tr><th>Type</th><th>By</th><th>Item No.</th><th>Item description</th><th>QTY</th><th>Cost</th><th>Date</th><th>Actions</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section id="materials-page" class="page" style="display:none">
      <div style="background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.04);margin-bottom:16px">
        <h3 style="margin:0 0 12px 0">Material Records</h3>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <!-- Material Records header and import/new buttons removed -->
        </div>
        <!-- Search Bar -->
        <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
          <div style="flex:1;min-width:200px;">
            <input type="text" id="materialsSearch" class="input" placeholder="Search materials by code, description, or category..." style="width:100%">
          </div>
        </div>
        <!-- Chart -->
        <div style="margin-top:12px;margin-bottom:12px;padding:8px;background:var(--card);border-radius:8px;border:1px solid var(--input-border);display:flex;gap:16px;align-items:flex-start;">
          <div style="flex:1;">
            <canvas id="stockDistributionChart" height="80" aria-label="Stock Distribution Chart"></canvas>
          </div>
          <button id="thresholdBtn" style="padding:8px 12px;background:var(--accent);color:#fff;border:0;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;">Threshold</button>
        </div>
        
        <!-- Threshold Popup Modal -->
        <div id="thresholdModal" class="modal-backdrop" style="display:none;z-index:100">
          <div class="modal" style="width:350px;padding:20px">
            <h3 style="margin-bottom:16px;text-align:center">Threshold Settings</h3>
            
            <div style="display:flex;flex-direction:column;gap:12px">
              <!-- Current Threshold Display -->
              <div style="display:flex;flex-direction:column;align-items:center;gap:6px;padding:12px;background:var(--bg);border-radius:8px">
                <div style="font-size:12px;color:var(--muted)">Current Threshold</div>
                <div style="font-size:32px;font-weight:700;color:var(--accent);" id="thresholdDisplay">100</div>
                <div style="font-size:12px;color:var(--muted)">units</div>
              </div>
              
              <!-- Threshold Input -->
              <div style="display:flex;flex-direction:column;gap:6px">
                <label style="font-size:13px;font-weight:600">Adjust Threshold</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <input type="number" id="thresholdInput" class="input" min="0" value="100" style="flex:1">
                  <span style="font-size:12px;color:var(--muted)">units</span>
                </div>
              </div>
              
              <!-- Increment/Decrement Buttons -->
              <div style="display:flex;gap:8px">
                <button id="decrementThreshold" class="btn ghost small" style="flex:1">- 10</button>
                <button id="incrementThreshold" class="btn ghost small" style="flex:1">+ 10</button>
              </div>
              
              <!-- Action Buttons -->
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="saveThreshold" class="btn" style="flex:1;background:var(--success)">Save</button>
                <button onclick="document.getElementById('thresholdModal').style.display='none'" class="btn ghost small" style="flex:1">Cancel</button>
              </div>
            </div>
          </div>
        </div>
        <div style="margin-top:12px;overflow:auto">
          <table id="materialsTable2">
            <thead>
              <tr><th>Item No.</th><th>Item description</th><th>QTY</th><th>Cost</th><th>Total Cost</th><th>Stock Level</th><th>Date</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="material-descriptions-page" class="page" style="display:none">
      <div style="background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.04);margin-bottom:16px">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0">Material Descriptions</h3>
          <button class="btn small" id="viewMaterialRecordsBtn">Go to Material Records</button>
        </div>
        <!-- Search Bar -->
        <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
          <div style="flex:1;min-width:200px;">
            <input type="text" id="descriptionsSearch" class="input" placeholder="Search by product, SKU, or category..." style="width:100%">
          </div>
        </div>
        <div id="materialDescriptionsContainer" style="margin-top:12px;display:flex;flex-direction:column;gap:20px">
          <!-- Material description cards will be inserted here -->
        </div>
      </div>
    </section>

    <section id="transactions-page" class="page" style="display:none">
      <div style="background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.04);margin-bottom:16px">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0">Material Transactions</h3>
          <div>
            <button class="btn small" id="newTxnBtn">Log Transaction</button>
          </div>
        </div>
        <!-- Search and Filters -->
        <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
          <div style="flex:1;min-width:200px;">
            <input type="text" id="transactionsSearch" class="input" placeholder="Search materials by code, description, or category..." style="width:100%">
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <label style="font-size:13px;color:var(--muted)">Filter Type:</label>
            <select id="transactionsTypeFilter" class="input" style="width:120px">
              <option value="">All</option>
              <option value="Received">Receiving</option>
              <option value="Issued">Issuance</option>
            </select>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <label style="font-size:13px;color:var(--muted)">Date:</label>
            <select id="transactionsDateFilter" class="input" style="width:120px">
              <option value="">All Time</option>
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
            </select>
          </div>
        </div>
        <!-- Chart -->
        <div style="margin-top:8px;margin-bottom:8px;padding:6px;background:var(--card);border-radius:8px;border:1px solid var(--input-border);">
          <canvas id="transactionVolumeChart" height="60" aria-label="Transaction Volume Chart" style="max-width:400px;margin:0 auto;"></canvas>
        </div>
        <div style="margin-top:12px;overflow:auto">
          <!-- Inline transaction entry form (visible on Transactions page) -->
          <div id="inlineTxn" style="display:none;margin-bottom:10px;">
            <form id="inlineTxnForm" style="display:grid;grid-template-columns:100px 140px 120px 1fr 80px 80px 120px auto;gap:10px;align-items:end;align-content:start">
              <label>Type
                <select class="input" id="inline_txnType" style="width:100%"><option>Received</option><option>Issued</option><option>Adjustment</option></select>
              </label>
              <label>By
                <input class="input" id="inline_txnBy" placeholder="Performed by" style="width:100%" />
              </label>
              <label>Item No.
                <input class="input" id="inline_txnSKU" placeholder="SKU" style="width:100%" />
              </label>
              <label>Item description
                <select class="input" id="inline_txnProductSelect" style="width:100%"></select>
              </label>
              <label class="inline-qty">QTY
                <input class="input" id="inline_txnQty" type="number" value="1" style="width:64px;text-align:right" />
              </label>
              <label class="inline-cost">Cost
                <input class="input" id="inline_txnCost" type="number" step="0.01" placeholder="Cost" style="width:64px;text-align:right" />
              </label>
              <label class="inline-date">Date
                <input class="input" id="inline_txnDate" type="date" value="${new Date().toISOString().slice(0,10)}" />
              </label>
              <div class="inline-actions" style="align-self:center">
                <button type="button" class="btn small" id="inlineSaveTxn">Save</button>
                <button type="button" class="btn ghost small" id="inlineCancelTxn">Cancel</button>
              </div>
            </form>
          </div>
          <table id="transactionsTableFull">
            <thead>
              <tr><th>Type</th><th>By</th><th>Item No.</th><th>Item description</th><th>QTY</th><th>Cost</th><th>Stock Level</th><th></th>Date</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="defects-page" class="page" style="display:none">
      <div style="background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.04);margin-bottom:16px">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0">Defects Log Reports</h3>
          <div>
            <button class="btn small" id="reportDefectBtn">Log Defect</button>
          </div>
        </div>
        <!-- Search and Filters -->
        <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
          <div style="flex:1;min-width:200px;">
            <input type="text" id="defectsSearch" class="input" placeholder="Search materials by code, description, or category..." style="width:100%">
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <label style="font-size:13px;color:var(--muted)">Date:</label>
            <select id="defectsDateFilter" class="input" style="width:120px">
              <option value="">All Time</option>
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
            </select>
          </div>
        </div>
        <!-- Chart -->
        <div style="margin-top:12px;margin-bottom:12px;padding:8px;background:var(--card);border-radius:8px;border:1px solid var(--input-border);">
          <canvas id="defectsByTypeChart" height="80" aria-label="Defects by Type Chart"></canvas>
        </div>
        <div style="margin-top:12px;overflow:auto">
          <table id="defectsTable">
            <thead>
              <tr><th>Type</th><th>By</th><th>Item No.</th><th>Item description</th><th>QTY</th><th>Note</th><th>Date</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="sap-data-page" class="page" style="display:none">
      <div style="background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.04);margin-bottom:16px">
        <h3 style="margin:0">SAP Data</h3>
        <style>
          .sap-import-body { font-family: Arial, sans-serif; margin: 20px; }
          .sap-import-body table { border-collapse: collapse; width: 100%; margin-top: 20px; }
          .sap-import-body th, .sap-import-body td { border: 1px solid #ccc; padding: 8px; text-align: left; }
          .sap-import-body th { background-color: #f4f4f4; text-align: center; }
          .sap-import-body input[type=file], .sap-import-body button { margin-top: 10px; margin-right: 10px; }
          .sap-import-body .button-bar { margin-top: 15px; }
          .dark .sap-import-body table { background-color: white; }
          .dark .sap-import-body th, .dark .sap-import-body td { color: black; }
        </style>
        <div class="sap-import-body">
          <!-- File Upload -->
          <input type="file" id="excelFile" accept=".xlsx, .xls, .csv">
          
          <!-- Action Buttons -->
          <div class="button-bar">
            <button id="refreshBtn">Refresh</button>
            <button id="saveBtn">Save to SAP Material</button>
          </div>

          <!-- Inventory Table -->
          <table id="inventoryTable">
            <thead>
              <tr>
                <th colspan="12">Inventory Details</th>
              </tr>
              <tr>
                <th colspan="2">UV LITE ACE</th>
                <th colspan="4">SAP SYSTEM</th>
                <th colspan="3">ACTUAL</th>
                <th colspan="3"></th>
              </tr>
              <tr>
                <th>Item No.</th>
                <th>Item Description</th>
                <th>Whse</th>
                <th>In-Whse Qty</th>
                <th>Counted</th>
                <th>Issued</th>
                <th>Counted Qty</th>
                <th>Variance</th>
                <th>Rejection</th>
                <th>BOM</th>
                <th>UoM</th>
                <th>Cost</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <!-- SheetJS Library -->
        <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
        <script>
          window.cachedData = null; // Store parsed Excel data

          function loadExcel(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
              try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                window.cachedData = jsonData; // Save for refresh

                renderTable(jsonData);
              } catch (err) {
                alert('Error reading file: ' + err.message);
              }
            };
            reader.readAsArrayBuffer(file);
          }

          function renderTable(jsonData) {
            const tbody = document.querySelector('#inventoryTable tbody');
            tbody.innerHTML = ''; // Clear old data

            jsonData.slice(1).forEach(row => {
              const tr = document.createElement('tr');
              for (let i = 0; i < 12; i++) {
                const td = document.createElement('td');
                td.textContent = row[i] ?? '';
                tr.appendChild(td);
              }
              tbody.appendChild(tr);
            });
          }

          // File Upload Event
          document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) loadExcel(file);
          });

          // Refresh Button
          document.getElementById('refreshBtn').addEventListener('click', function() {
            if (window.cachedData) {
              renderTable(window.cachedData);
              alert('Table refreshed!');
            } else {
              alert('No data loaded yet. Please upload an Excel file first.');
            }
          });

          // Save Button
          document.getElementById('saveBtn').addEventListener('click', function() {
            if (!window.cachedData) {
              alert('No data to save. Please upload an Excel file first.');
              return;
            }

            // Process and append to sapInventory
            const importNo = nextImportNo++;
            const newData = window.cachedData.slice(1).map(row => ({
              itemNo: row[0] || '',
              description: row[1] || '',
              whse: row[2] || '',
              inWhseQty: row[3] || '',
              counted: row[4] || '',
              issued: row[5] || '',
              countedQty: row[6] || '',
              variance: row[7] || '',
              rejection: row[8] || '',
              bom: row[9] || '',
              uom: row[10] || '',
              cost: row[11] || '',
              importNo: importNo
            }));

            sapInventory.push(...newData);

            saveState();

            // Add to history
            addHistory('Import', 'SAP Data Saved', `Saved ${newData.length} items to SAP Inventory`);

            alert('Data has been saved to SAP Inventory.');

            // Refresh the inventory display
            buildSapInventoryTable();
            buildComparisonTables();
          });
        </script>
      </div>

      <!-- SAP Inventory Section -->
      <div class="panel" style="margin-top: 40px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h3>SAP Inventory</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <input type="text" id="sapFilter" placeholder="Filter by Import No." class="input" style="width:150px" />
            <button class="btn small" id="applySapFilter">Filter</button>
            <button class="btn small" id="clearSapFilter">Clear</button>
            <button class="btn small" id="removeAllImports">Remove All Imports</button>
          </div>
        </div>
        <style>
          #sap-data-page .card table { border-collapse: collapse; width: 100%; margin-top: 8px; }
          #sap-data-page .card th, #sap-data-page .card td { border: 1px solid #ccc; padding: 6px; text-align: left; font-size: 13px; }
          #sap-data-page .card th { background-color: #f4f4f4; }
          .dark #sap-data-page .card table { background-color: white; }
          .dark #sap-data-page .card th, .dark #sap-data-page .card td { color: black; }
        </style>
      </div>
    </section>

    <section id="comparison-page" class="page" style="display:none">
      <div style="background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.04);margin-bottom:16px">
        <h3 style="margin:0">Comparison</h3>
        <style>
          .comparisonTable { border-collapse: collapse; width: 100%; margin-top: 8px; }
          .comparisonTable th, .comparisonTable td { border: 1px solid var(--input-border); padding: 6px; text-align: left; font-size: 13px; }
          .comparisonTable th { background-color: var(--accent); color: #fff; font-weight: 600; }
          .comparisonTable thead tr:first-child th { background-color: var(--card); color: var(--text); font-weight: bold; text-align: center; }
          .comparisonTable thead tr:nth-child(2) th { background-color: var(--card); color: var(--text); font-weight: bold; text-align: center; }
          .dark .comparisonTable { background-color: var(--card); }
          .dark .comparisonTable th, .dark .comparisonTable td { color: var(--text); }
        </style>
        <div style="margin-top:12px;overflow:auto">
          <h4>Table 1</h4>
          <table class="comparisonTable">
            <thead>
              <tr>
                <th colspan="11">Inventory Details</th>
              </tr>
              <tr>
                <th colspan="2">UV LITE ACE</th>
                <th colspan="4">SAP SYSTEM</th>
                <th colspan="3">ACTUAL</th>
                <th colspan="2"></th>
              </tr>
              <tr>
                <th>Item No.</th>
                <th>Item Description</th>
                <th>Whse</th>
                <th>In-Whse Qty</th>
                <th>Counted</th>
                <th>Issued</th>
                <th>Counted Qty</th>
                <th>Variance</th>
                <th>Rejection</th>
                <th>BOM</th>
                <th>UoM</th>
                <th>Cost</th>
              </tr>
            </thead>
            <tbody id="table1tbody">
              <tr>
                <td>RM-01-06-0021--</td>
                <td>BI PIPE 1MM x RD 25.4MM x 20' SCHED</td>
                <td>RM-Cab</td>
                <td>2,381</td>
                <td>Y</td>
                <td>120</td>
                <td>2,380</td>
                <td>-1</td>
                <td>1</td>
                <td>4</td>
                <td>PCS</td>
                <td>303</td>
              </tr>
              <tr>
                <td>RM-01-06-0059--</td>
                <td>PE TRANS POLYBAG UV CUSHION (20√ó53√ó26 mic)</td>
                <td>RM-Cab</td>
                <td>2,331</td>
                <td>Y</td>
                <td>120</td>
                <td>2,331</td>
                <td>0</td>
                <td>0</td>
                <td>4</td>
                <td>PCS</td>
                <td>3.4107</td>
              </tr>
              <tr>
                <td>RM-01-06-0060-</td>
                <td>PE TRANS SLIT ONE SIDE UV BACK REST (10√ó100√ó26 mic)</td>
                <td>RM-Cab</td>
                <td>3,680</td>
                <td>Y</td>
                <td>60</td>
                <td>3,680</td>
                <td>0</td>
                <td>0</td>
                <td>2</td>
                <td>PCS</td>
                <td>3.2148</td>
              </tr>
              <tr>
                <td>RM-01-06-0079-</td>
                <td>MS PLATE 2MM BACK RESTER BRTK ‚Äì LITE ACE</td>
                <td>RM-Cab</td>
                <td>3,120</td>
                <td>Y</td>
                <td>120</td>
                <td>3,115</td>
                <td>-5</td>
                <td>5</td>
                <td>4</td>
                <td>PCS</td>
                <td>208.143</td>
              </tr>
              <tr>
                <td>RM-01-06-0080-</td>
                <td>MS PLATE 2MM MID LEG BRTK (RH/LH) ‚Äì LITE ACE</td>
                <td>RM-Cab</td>
                <td>1,076</td>
                <td>Y</td>
                <td>60</td>
                <td>1,070</td>
                <td>-6</td>
                <td>6</td>
                <td>2</td>
                <td>PCS</td>
                <td>208.143</td>
              </tr>
              <tr>
                <td>RM-01-06-0054-</td>
                <td>FOAM 25MM BACK REST UV LITE ACE</td>
                <td>RM-Cab</td>
                <td>1,260</td>
                <td>Y</td>
                <td>60</td>
                <td>1,260</td>
                <td>0</td>
                <td>0</td>
                <td>2</td>
                <td>PCS</td>
                <td>163.393</td>
              </tr>
              <tr>
                <td>RM-01-06-0055-</td>
                <td>FOAM 50MM SEAT CUSHION UV LITE ACE</td>
                <td>RM-Cab</td>
                <td>1,812</td>
                <td>Y</td>
                <td>120</td>
                <td>1,800</td>
                <td>-12</td>
                <td>12</td>
                <td>4</td>
                <td>PCS</td>
                <td>700</td>
              </tr>
              <tr>
                <td>RM-01-06-0056-</td>
                <td>FOAM 5MM SC UV LITE ACE</td>
                <td>RM-Cab</td>
                <td>1,812</td>
                <td>Y</td>
                <td>120</td>
                <td>1,800</td>
                <td>-12</td>
                <td>12</td>
                <td>4</td>
                <td>PCS</td>
                <td>92.857</td>
              </tr>
              <tr>
                <td>RM-01-06-0057-</td>
                <td>FOAM 5MM BR UV LITE ACE</td>
                <td>RM-Cab</td>
                <td>1,260</td>
                <td>Y</td>
                <td>60</td>
                <td>1,260</td>
                <td>0</td>
                <td>0</td>
                <td>2</td>
                <td>PCS</td>
                <td>66.071</td>
              </tr>
              <tr>
                <td>RM-01-06-0058--</td>
                <td>TRICOT 8MM (SC/BR) UV LITE ACE</td>
                <td>RM-Cab</td>
                <td>5,698</td>
                <td>Y</td>
                <td>180</td>
                <td>5,698</td>
                <td>0</td>
                <td>0</td>
                <td>6</td>
                <td>PCS</td>
                <td>271.429</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div style="margin-top:24px;overflow:auto">
          <h4>Table 2</h4>
          <table class="comparisonTable">
            <thead>
              <tr>
                <th colspan="14">Inventory Details</th>
              </tr>
              <tr>
                <th colspan="2">UV LITE ACE</th>
                <th colspan="4">SAP SYSTEM</th>
                <th colspan="6">IVMS</th>
                <th colspan="2"></th>
              </tr>
              <tr>
                <th>Item No.</th>
                <th>Item Description</th>
                <th>Whse</th>
                <th>In-Whse Qty</th>
                <th>Counted</th>
                <th>Issued</th>
                <th>Received</th>
                <th>Issued</th>
                <th>Rejection</th>
                <th>Variance</th>
                <th>Status</th>
                <th>BOM</th>
                <th>UoM</th>
                <th>Cost</th>
              </tr>
            </thead>
            <tbody id="table2tbody">
              <tr>
                <td>RM-01-06-0021--</td>
                <td>BI PIPE 1MM x RD 25.4MM x 20' SCHED</td>
                <td>RM-Cab</td>
                <td>2,381</td>
                <td>Y</td>
                <td>120</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>4</td>
                <td>PCS</td>
                <td>303</td>
              </tr>
              <tr>
                <td>RM-01-06-0059--</td>
                <td>PE TRANS POLYBAG UV CUSHION (20√ó53√ó26 mic)</td>
                <td>RM-Cab</td>
                <td>2,331</td>
                <td>Y</td>
                <td>120</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>4</td>
                <td>PCS</td>
                <td>3.4107</td>
              </tr>
              <tr>
                <td>RM-01-06-0060-</td>
                <td>PE TRANS SLIT ONE SIDE UV BACK REST (10√ó100√ó26 mic)</td>
                <td>RM-Cab</td>
                <td>3,680</td>
                <td>Y</td>
                <td>60</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>2</td>
                <td>PCS</td>
                <td>3.2148</td>
              </tr>
              <tr>
                <td>RM-01-06-0079-</td>
                <td>MS PLATE 2MM BACK RESTER BRTK ‚Äì LITE ACE</td>
                <td>RM-Cab</td>
                <td>3,120</td>
                <td>Y</td>
                <td>120</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>4</td>
                <td>PCS</td>
                <td>208.143</td>
              </tr>
              <tr>
                <td>RM-01-06-0080-</td>
                <td>MS PLATE 2MM MID LEG BRTK (RH/LH) ‚Äì LITE ACE</td>
                <td>RM-Cab</td>
                <td>1,076</td>
                <td>Y</td>
                <td>60</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>2</td>
                <td>PCS</td>
                <td>208.143</td>
              </tr>
              <tr>
                <td>RM-01-06-0054-</td>
                <td>FOAM 25MM BACK REST UV LITE ACE</td>
                <td>RM-Cab</td>
                <td>1,260</td>
                <td>Y</td>
                <td>60</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>2</td>
                <td>PCS</td>
                <td>163.393</td>
              </tr>
              <tr>
                <td>RM-01-06-0055-</td>
                <td>FOAM 50MM SEAT CUSHION UV LITE ACE</td>
                <td>RM-Cab</td>
                <td>1,812</td>
                <td>Y</td>
                <td>120</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>4</td>
                <td>PCS</td>
                <td>700</td>
              </tr>
              <tr>
                <td>RM-01-06-0056-</td>
                <td>FOAM 5MM SC UV LITE ACE</td>
                <td>RM-Cab</td>
                <td>1,812</td>
                <td>Y</td>
                <td>120</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>4</td>
                <td>PCS</td>
                <td>92.857</td>
              </tr>
              <tr>
                <td>RM-01-06-0057-</td>
                <td>FOAM 5MM BR UV LITE ACE</td>
                <td>RM-Cab</td>
                <td>1,260</td>
                <td>Y</td>
                <td>60</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>2</td>
                <td>PCS</td>
                <td>66.071</td>
              </tr>
              <tr>
                <td>RM-01-06-0058--</td>
                <td>TRICOT 8MM (SC/BR) UV LITE ACE</td>
                <td>RM-Cab</td>
                <td>5,698</td>
                <td>Y</td>
                <td>180</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>6</td>
                <td>PCS</td>
                <td>271.429</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div style="margin-top:24px">
        <h4>Analysis: Comparison of Table 1 (SAP) and Table 2 (IVMS)</h4>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px">
          <div class="panel" style="padding:8px;height:400px">
            <h5>Status Distribution</h5>
            <canvas id="statusPieChart" style="max-height:300px"></canvas>
            <div style="margin-top:12px;padding:8px;background:var(--bg);border-radius:8px">
              <div style="font-size:12px;color:var(--muted)">Overall Match Rate</div>
              <div style="font-size:18px;font-weight:700;color:var(--text)">87.5%</div>
            </div>
          </div>
          <div class="panel" style="padding:8px;height:400px">
            <h5>Variance per Item (Top 10)</h5>
            <canvas id="varianceBarChart"></canvas>
          </div>
        </div>
      </div>
    </section>

    <section id="settings-page" class="page" style="display:none">
      <div style="display:flex;flex-direction:column;gap:16px">
        <!-- General Settings Panel -->
        <div style="background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.04)">
          <h3 style="margin:0 0 10px 0">General Settings</h3>
          <div style="margin-top:10px;display:flex;flex-direction:column;gap:10px">
            <label style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:600">Enable Alerts</div>
                <div style="font-size:13px;color:var(--muted)">Notify when items reach thresholds</div>
              </div>
              <input type="checkbox" id="toggleAlerts" checked />
            </label>

            <label style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:600">Auto Reorder</div>
                <div style="font-size:13px;color:var(--muted)">Automatically create POs for critical items</div>
              </div>
              <input type="checkbox" id="toggleReorder" />
            </label>

            <div style="margin-top:8px">
              <div style="font-weight:600;margin-bottom:6px">Default Threshold (units)</div>
              <input class="input" id="defaultThreshold" type="number" min="0" value="100" style="width:120px" />
            </div>

            <div style="margin-top:8px;text-align:right">
              <button class="btn" id="saveSettings">Save</button>
            </div>
          </div>
        </div>

        <!-- User Management Panel -->
        <div style="background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.04)">
          <h3 style="margin:0 0 10px 0">üë• User Management</h3>
          <div style="margin-bottom:16px">
            <p style="font-size:13px;color:var(--muted);margin-bottom:12px">Registered Users</p>
            <p style="font-size:13px;margin-bottom:16px">View and manage user accounts</p>
            
            <table id="usersManagementTable" style="width:100%;border-collapse:collapse">
              <thead>
                <tr style="border-bottom:2px solid var(--input-border)">
                  <th style="padding:10px;text-align:left;color:var(--muted);font-weight:600;font-size:13px">Username</th>
                  <th style="padding:10px;text-align:left;color:var(--muted);font-weight:600;font-size:13px">Email</th>
                  <th style="padding:10px;text-align:left;color:var(--muted);font-weight:600;font-size:13px">Current Role</th>
                  <th style="padding:10px;text-align:left;color:var(--muted);font-weight:600;font-size:13px">Grant Access</th>
                  <th style="padding:10px;text-align:left;color:var(--muted);font-weight:600;font-size:13px">Actions</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <tr style="border-bottom:1px solid var(--input-border)">
                  <td colspan="5" style="padding:20px;text-align:center;color:var(--muted)">No registered users yet. Add users to manage access.</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Add New User Form -->
          <div style="margin-top:16px;padding:16px;background:var(--input-bg);border-radius:8px;border:1px solid var(--input-border)">
            <h4 style="margin-bottom:12px;font-size:14px">Add New User</h4>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px">
              <div>
                <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px">Username</label>
                <input class="input" id="newUsername" type="text" placeholder="Enter username" style="width:100%"/>
              </div>
              <div>
                <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px">Email</label>
                <input class="input" id="newEmail" type="email" placeholder="Enter email" style="width:100%"/>
              </div>
              <div>
                <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px">Role</label>
                <select class="input" id="newUserRole" style="width:100%">
                  <option value="student">Student</option>
                  <option value="employee">Employee</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
            </div>
            <div style="text-align:right">
              <button class="btn" id="addUserBtn" style="padding:8px 16px;font-size:13px">+ Add User</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="linear-programming-page" class="page">
      <h1>üìä Inventory Allocation Optimizer</h1>
      
      <!-- Demand Tracking Section -->
      <div style="background:var(--card);padding:16px;border-radius:12px;margin-bottom:20px;box-shadow:0 6px 18px rgba(15,23,42,0.04)">
        <h2 style="margin-bottom:16px;">üìà Demand Tracking & Bill of Materials</h2>
        
        <div style="margin-bottom:16px">
          <label style="display:block;margin-bottom:8px;font-weight:600;">Target Demand (Input)</label>
          <div style="display:flex;gap:8px;align-items:flex-start">
            <div>
              <input type="number" id="targetDemandInput" value="100" min="0" style="padding:10px;border-radius:8px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);width:150px">
              <small style="display:block;color:var(--muted);font-size:12px;margin-top:4px;">Enter the desired quantity to produce</small>
            </div>
            <button id="saveTargetDemandBtn" class="btn" style="margin-top:25px;padding:8px 12px;font-size:13px">Save</button>
          </div>
        </div>

        <table style="width:100%;margin-bottom:16px;border-collapse:collapse">
          <thead>
            <tr style="border-bottom:2px solid var(--input-border)">
              <th style="padding:10px;text-align:left;color:var(--muted);font-weight:600;font-size:13px">Target Demand</th>
              <th style="padding:10px;text-align:left;color:var(--muted);font-weight:600;font-size:13px">Total Demand Needed</th>
              <th style="padding:10px;text-align:left;color:var(--muted);font-weight:600;font-size:13px">Unit Produced</th>
              <th style="padding:10px;text-align:left;color:var(--muted);font-weight:600;font-size:13px">Remaining Demand</th>
              <th style="padding:10px;text-align:left;color:var(--muted);font-weight:600;font-size:13px">Status</th>
            </tr>
          </thead>
          <tbody>
            <tr style="border-bottom:1px solid var(--input-border)">
              <td style="padding:10px;font-size:14px;font-weight:600"><span id="displayTargetDemand">100</span></td>
              <td style="padding:10px;font-size:14px;font-weight:600"><span id="totalDemandNeeded">100</span></td>
              <td style="padding:10px;font-size:14px;font-weight:600;color:var(--success)"><span id="unitProduced">0</span></td>
              <td style="padding:10px;font-size:14px;font-weight:600;color:var(--accent)"><span id="remainingDemand">100</span></td>
              <td style="padding:10px;font-size:14px;font-weight:600"><span id="demandStatusBadge" class="badge gray">Pending</span></td>
            </tr>
          </tbody>
        </table>

        <h3 style="margin-top:20px;margin-bottom:12px;">Bill of Materials</h3>
        <table id="billOfMaterialsTable" style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="border-bottom:2px solid var(--input-border)">
              <th style="padding:10px;text-align:left;color:var(--muted);font-weight:600;font-size:13px">Item No.</th>
              <th style="padding:10px;text-align:left;color:var(--muted);font-weight:600;font-size:13px">Item Description</th>
              <th style="padding:10px;text-align:left;color:var(--muted);font-weight:600;font-size:13px">Bill of Materials (Qty/Unit)</th>
              <th style="padding:10px;text-align:left;color:var(--muted);font-weight:600;font-size:13px">Total Required</th>
              <th style="padding:10px;text-align:left;color:var(--muted);font-weight:600;font-size:13px">Quantity Issued</th>
              <th style="padding:10px;text-align:left;color:var(--muted);font-weight:600;font-size:13px">Available</th>
            </tr>
          </thead>
          <tbody id="billOfMaterialsTbody"></tbody>
        </table>

        <div id="insufficientMaterialsAlert" style="margin-top:16px;padding:12px;border-radius:8px;background:var(--input-bg);border-left:4px solid var(--danger);display:none">
          <h4 style="margin:0 0 10px 0;color:var(--danger);font-size:14px">‚ö†Ô∏è Insufficient Materials to Produce 1 Unit</h4>
          <div id="insufficientMaterialsList" style="font-size:13px;color:var(--text)"></div>
        </div>

        <div id="sufficientMaterialsAlert" style="margin-top:16px;padding:12px;border-radius:8px;background:var(--input-bg);border-left:4px solid var(--success);display:none">
          <h4 style="margin:0;color:var(--success);font-size:14px">‚úÖ All Materials Issued - 1 Unit Ready to Produce</h4>
        </div>

        <div id="demandMetAlert" style="margin-top:16px;padding:12px;border-radius:8px;background:rgba(16, 185, 129, 0.1);border-left:4px solid var(--success);display:none">
          <h4 style="margin:0;color:var(--success);font-size:14px">üéØ Demand Met!</h4>
          <p style="margin:6px 0 0 0;font-size:13px;color:var(--text)">Target Demand: <span id="demandMetTargetDisplay">0</span> | Units Produced: <span id="demandMetProducedDisplay">0</span></p>
        </div>

        <div id="demandUnmetAlert" style="margin-top:16px;padding:12px;border-radius:8px;background:rgba(244, 165, 130, 0.1);border-left:4px solid var(--warning);display:none">
          <h4 style="margin:0;color:var(--warning);font-size:14px">üìä Demand Not Yet Met</h4>
          <p style="margin:6px 0 0 0;font-size:13px;color:var(--text)">Target Demand: <span id="demandUnmetTargetDisplay">0</span> | Units Produced: <span id="demandUnmetProducedDisplay">0</span> | Still Need: <span id="demandStillNeeded" style="font-weight:600;color:var(--warning)">0</span></p>
        </div>
      </div>

      <hr style="margin:20px 0;border:none;border-top:1px solid var(--input-border)">
      
      <p style="text-align:center;">
        Total Demand (D) = 
        <input type="number" id="demandInput" value="300"> units
        <br><small style="color:var(--muted);font-size:12px;">üîÑ Auto-update every 5 seconds</small>
      </p>

      <table id="lpMaterialsTable">
        <thead>
          <tr>
            <th>Material</th>
            <th>Available Qty (Si)</th>
            <th>Cost / Unit (Ci)</th>
          </tr>
        </thead>
        <tbody id="lpMaterialsTbody"></tbody>
      </table>

      <div style="text-align:center;margin:12px 0;">
        <button id="autoUpdateBtn" class="btn" onclick="toggleAutoUpdate()">
          üîÑ Auto Update: <span id="autoUpdateStatus">ON</span>
        </button>
      </div>

      <div id="output" class="result"></div>
    </section>

  </main>

  <!-- Modal root -->
  <div id="modalRoot" style="display:none"></div>
  <!-- Toast root -->
  <div id="toastRoot"></div>

  <script>
    // --- Demo data store (can be replaced by API calls) ---
    let materials = [
      {id:1, product:"Steel Rods - Grade A", sku:"SR001", category:"Raw Materials", description:"High tensile steel rods", qty:"√ò20mm", stock:450, location:"WH-A", updated:"2025-11-09", cost:0},
      {id:2, product:"Aluminum Sheets", sku:"AS102", category:"Raw Materials", description:"Aluminum 6061", qty:"2mm", stock:85, location:"WH-B", updated:"2025-11-08", cost:0},
      {id:3, product:"Copper Wire", sku:"CW203", category:"Components", description:"Copper conductor", qty:"AWG 18", stock:0, location:"WH-A", updated:"2025-11-01", cost:0},
      {id:4, product:"Plastic Pellets", sku:"PP304", category:"Raw Materials", description:"Polypropylene pellets", qty:"Grade B", stock:1200, location:"WH-C", updated:"2025-11-09", cost:0},
      {id:5, product:"Rubber Gaskets", sku:"RG501", category:"Components", description:"NBR gaskets", qty:"Size M", stock:45, location:"WH-B", updated:"2025-11-07", cost:0},
      {id:6, product:"Fastener Kit", sku:"FK777", category:"Hardware", description:"Assorted fasteners", qty:"Box", stock:12, location:"WH-A", updated:"2025-11-05", cost:0},
      {id:7, product:"BI PIPE 1MM x Rp OD 25.4MM x 20' SCHED", sku:"RM-01-06-0021-", category:"Raw Materials", description:"", qty:"", stock:0, location:"", updated:"2025-12-30", cost:303},
      {id:8, product:"PE TRANS POLYBAG UV CUSHION (20 x 53 x 26 mic)", sku:"RM-01-06-0059-", category:"Raw Materials", description:"", qty:"", stock:0, location:"", updated:"2025-12-30", cost:3.4107},
      {id:9, product:"PE TRANS SLIT ONE SIDE UV BACK REST (10 x 100 x 26 mic)", sku:"RM-01-06-0060", category:"Raw Materials", description:"", qty:"", stock:0, location:"", updated:"2025-12-30", cost:3.2148},
      {id:10, product:"MS PLATE 2MM BACK REST EAR BRKT - LITE ACE", sku:"RM-01-06-0079", category:"Raw Materials", description:"", qty:"", stock:0, location:"", updated:"2025-12-30", cost:208.143},
      {id:11, product:"MS PLATE 2MM MID LEG BRKT ( RH / LH ) - LITE ACE", sku:"RM-01-06-0080", category:"Raw Materials", description:"", qty:"", stock:0, location:"", updated:"2025-12-30", cost:208.143},
      {id:12, product:"FOAM 25MM BACK REST UV Lite Ace (158.75mm x 2235.22mm)", sku:"RM-01-06-0054", category:"Raw Materials", description:"", qty:"", stock:0, location:"", updated:"2025-12-30", cost:163.393},
      {id:13, product:"FOAM 50MM SEAT CUSHION UV Lite Ace (349.25mm x 1117.6mm)", sku:"RM-01-06-0055", category:"Raw Materials", description:"", qty:"", stock:0, location:"", updated:"2025-12-30", cost:700},
      {id:14, product:"FOAM 5mm SC UV Lite Ace (101.6mm x 2908.3mm)", sku:"RM-01-06-0056", category:"Raw Materials", description:"", qty:"", stock:0, location:"", updated:"2025-12-30", cost:92.857},
      {id:15, product:"FOAM 5mm BR UV Lite Ace (88.9mm x4699mm)", sku:"RM-01-06-0057", category:"Raw Materials", description:"", qty:"", stock:0, location:"", updated:"2025-12-30", cost:66.071},
      {id:16, product:"TRICOT 8MM ( SC / BR ) UV Lite Ace (340mm x 1140mm)", sku:"RM-01-06-0058-", category:"Raw Materials", description:"", qty:"", stock:0, location:"", updated:"2025-12-30", cost:271.429}
    ];

    // sample transactions (showing received and issued)
    let transactions = [
      {id:1001, date:"2025-11-09", type:"Received", sku:"PP304", product:"Plastic Pellets", qty:500, by:"Alice"},
      {id:1002, date:"2025-11-08", type:"Issued", sku:"SR001", product:"Steel Rods - Grade A", qty:50, by:"Bob"},
      {id:1003, date:"2025-11-06", type:"Received", sku:"RG501", product:"Rubber Gaskets", qty:100, by:"Carol"},
      {id:1004, date:"2025-11-05", type:"Issued", sku:"FK777", product:"Fastener Kit", qty:8, by:"Dan"},
      {id:1005, date:"2025-11-10", type:"Received", sku:"RM-01-06-0021--", product:"BI PIPE 1MM x RD 25.4MM x 20' SCHED", qty:100, by:"Eve"},
      {id:1006, date:"2025-11-11", type:"Issued", sku:"RM-01-06-0021--", product:"BI PIPE 1MM x RD 25.4MM x 20' SCHED", qty:120, by:"Frank"},
      {id:1007, date:"2025-11-12", type:"Received", sku:"RM-01-06-0059--", product:"PE TRANS POLYBAG UV CUSHION (20√ó53√ó26 mic)", qty:200, by:"Grace"},
      {id:1008, date:"2025-11-13", type:"Issued", sku:"RM-01-06-0059--", product:"PE TRANS POLYBAG UV CUSHION (20√ó53√ó26 mic)", qty:120, by:"Henry"}
    ];

    // Bill of Materials for product
    let billOfMaterials = [
      {itemNo: 1, sku:"RM-01-06-0021-", description:"BI PIPE 1MM x RD 25.4MM x 20' SCHED", qtyPerUnit:4},
      {itemNo: 2, sku:"RM-01-06-0059-", description:"PE TRANS POLYBAG UV CUSHION (20√ó53√ó26 mic)", qtyPerUnit:4},
      {itemNo: 3, sku:"RM-01-06-0060-", description:"PE TRANS SLIT ONE SIDE UV BACK REST (10√ó100√ó26 mic)", qtyPerUnit:2},
      {itemNo: 4, sku:"RM-01-06-0079-", description:"MS PLATE 2MM BACK RESTER BRTK ‚Äì LITE ACE", qtyPerUnit:4},
      {itemNo: 5, sku:"RM-01-06-0080-", description:"MS PLATE 2MM MID LEG BRTK (RH/LH) ‚Äì LITE ACE", qtyPerUnit:2},
      {itemNo: 6, sku:"RM-01-06-0054-", description:"FOAM 25MM BACK REST UV LITE ACE", qtyPerUnit:2},
      {itemNo: 7, sku:"RM-01-06-0055-", description:"FOAM 50MM SEAT CUSHION UV LITE ACE", qtyPerUnit:4},
      {itemNo: 8, sku:"RM-01-06-0056-", description:"FOAM 5MM SC UV LITE ACE", qtyPerUnit:4},
      {itemNo: 9, sku:"RM-01-06-0057-", description:"FOAM 5MM BR UV LITE ACE", qtyPerUnit:2},
      {itemNo: 10, sku:"RM-01-06-0058-", description:"TRICOT 8MM (SC/BR) UV LITE ACE", qtyPerUnit:6}
    ];

    // product library for Item descriptions
    let productLibrary = [
      "BI PIPE 1MM x Rp OD 25.4MM x 20' SCHED",
      "PE TRANS POLYBAG UV CUSHION (20 x 53 x 26 mic)",
      "PE TRANS SLIT ONE SIDE UV BACK REST (10 x 100 x 26 mic)",
      "MS PLATE 2MM BACK REST EAR BRKT - LITE ACE",
      "MS PLATE 2MM MID LEG BRKT ( RH / LH ) - LITE ACE",
      "FOAM 25MM BACK REST UV Lite Ace (158.75mm x 2235.22mm)",
      "FOAM 50MM SEAT CUSHION UV Lite Ace (349.25mm x 1117.6mm)",
      "FOAM 5mm SC UV Lite Ace (101.6mm x 2908.3mm)",
      "FOAM 5mm BR UV Lite Ace (88.9mm x4699mm)",
      "TRICOT 8MM ( SC / BR ) UV Lite Ace (340mm x 1140mm)"
    ];

    // map product description -> SKU (used to autofill Item No when selecting a product)
    const productSKUMap = {
      "BI PIPE 1MM x Rp OD 25.4MM x 20' SCHED": "RM-01-06-0021-",
      "PE TRANS POLYBAG UV CUSHION (20 x 53 x 26 mic)": "RM-01-06-0059-",
      "PE TRANS SLIT ONE SIDE UV BACK REST (10 x 100 x 26 mic)": "RM-01-06-0060-",
      "MS PLATE 2MM BACK REST EAR BRKT - LITE ACE": "RM-01-06-0079-",
      "MS PLATE 2MM MID LEG BRKT ( RH / LH ) - LITE ACE": "RM-01-06-0080-",
      "FOAM 25MM BACK REST UV Lite Ace (158.75mm x 2235.22mm)": "RM-01-06-0054-",
      "FOAM 50MM SEAT CUSHION UV Lite Ace (349.25mm x 1117.6mm)": "RM-01-06-0055-",
      "FOAM 5mm SC UV Lite Ace (101.6mm x 2908.3mm)": "RM-01-06-0056-",
      "FOAM 5mm BR UV Lite Ace (88.9mm x4699mm)": "RM-01-06-0057-",
      "TRICOT 8MM ( SC / BR ) UV Lite Ace (340mm x 1140mm)": "RM-01-06-0058-",
      // tolerate alternate spacing/parentheses variants by mapping additional keys if needed
    };

    // map SKU -> Cost (used to autofill Cost when selecting SKU or product)
    const skuCostMap = {
      "RM-01-06-0021-": 303,
      "RM-01-06-0059-": 3.4107,
      "RM-01-06-0060-": 3.2148,
      "RM-01-06-0079-": 208.143,
      "RM-01-06-0080-": 208.143,
      "RM-01-06-0054-": 163.393,
      "RM-01-06-0055-": 700,
      "RM-01-06-0056-": 92.857,
      "RM-01-06-0057-": 66.071,
      "RM-01-06-0058-": 271.429
    };

    // defects with types, status
    let defects = [
      {type:"Warping", by:"John Doe", sku:"AS102", product:"Aluminum Sheets", qty:5, note:"Warped during storage", date:"2025-11-07", status:"Open"},
      {type:"Contamination", by:"Jane Smith", sku:"PP304", product:"Plastic Pellets", qty:10, note:"Foreign particles found", date:"2025-11-04", status:"Resolved"},
      {type:"Tears", by:"Bob Johnson", sku:"RG501", product:"Rubber Gaskets", qty:2, note:"Torn edges", date:"2025-10-29", status:"Open"}
    ];

    // alerts log for auto notifications when stock goes low
    let alerts = [];

    // SAP Inventory data
    let sapInventory = [];

    // Next import number
    let nextImportNo = 1;

    // history events (persisted) ‚Äî will store user-visible timeline entries
    let history = [];

    // --- Persistence helpers (localStorage) ---
    const STORAGE_KEY = 'inventoryProState-v1';
    function saveState(){
      try{
        const state = { materials, transactions, defects, history, settings, productLibrary, alerts, sapInventory, nextImportNo };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch(e){ console.warn('Failed to save state', e); }
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const state = JSON.parse(raw);
        if(state.materials && Array.isArray(state.materials)) materials = state.materials;
        if(state.transactions && Array.isArray(state.transactions)) transactions = state.transactions;
        if(state.defects && Array.isArray(state.defects)) defects = state.defects;
        if(state.history && Array.isArray(state.history)) history = state.history;
        if(state.settings && typeof state.settings === 'object') settings = state.settings;
        if(state.productLibrary && Array.isArray(state.productLibrary)) productLibrary = state.productLibrary;
        if(state.alerts && Array.isArray(state.alerts)) alerts = state.alerts;
        if(state.sapInventory && Array.isArray(state.sapInventory)) sapInventory = state.sapInventory;
        if(state.nextImportNo && typeof state.nextImportNo === 'number') nextImportNo = state.nextImportNo;
      } catch(e){ console.warn('Failed to load state', e); }
    }

    // settings + last-action / undo helper
    let settings = { serverSyncEnabled:false, serverUrl:'' };
    // store last transaction action for undo (create/edit/delete)
    let lastTransactionAction = null;

    // attempt to sync to a configured server (if enabled)
    async function syncToServer(){
      try{
        if(!settings.serverSyncEnabled) return;
        const url = (settings.serverUrl || '').replace(/\/$/, '');
        if(!url) return;
        // POST the full state to server
        const res = await fetch(`${url}/api/state`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({materials, transactions, defects, history}) });
        if(!res.ok) console.warn('Server sync failed', res.status);
        else addHistory('Sync','Synced to server', `State sent to ${url}`);
      } catch(e){ console.warn('Server sync error', e); }
    }

    // load persisted data (if present) so the UI stays synced across reloads
    loadState();
    // Update material costs from transactions after loading
    updateMaterialCostsFromTransactions();
    // if there's no history (fresh demo), seed it from existing demo transactions & defects
    if(!history || history.length===0){
      // seed a few demo history events so the History page isn't empty
      transactions.slice().reverse().forEach(t=> addHistory('Transaction', t.product || t.sku || 'Transaction', `${t.type} ${t.qty} x ${t.sku} (${t.product})`, t.sku));
      defects.slice().reverse().forEach(d=> addHistory('Defect', d.product || d.sku || 'Defect', `${d.type} on ${d.sku} (${d.product}) ‚Äî ${d.status}`, d.sku));
    }

    // --- DOM helpers ---
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // prevent duplicate transactions: consider same SKU, type, qty, date, by as duplicate
    function isDuplicateTransaction(tx){
      if(!tx) return false;
      return transactions.some(t => (
        String(t.sku||'') === String(tx.sku||'') &&
        String(t.type||'') === String(tx.type||'') &&
        Number(t.qty||0) === Number(tx.qty||0) &&
        String(t.date||'') === String(tx.date||'') &&
        String((t.by||'').toLowerCase()) === String((tx.by||'').toLowerCase())
      ));
    }

    function isDuplicateMaterial(mat){
      if(!mat) return false;
      return materials.some(m => String(m.sku||'').toLowerCase() === String(mat.sku||'').toLowerCase());
    }

    // --- Login System ---
    let currentUser = null;
    let isLoggedIn = false;

    // Check if user is already logged in
    function checkLoginStatus() {
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          isLoggedIn = true;
          showDashboard();
        } catch (e) {
          console.warn('Failed to load user session', e);
          showLoginPage();
        }
      } else {
        showLoginPage();
      }
    }

    // Show login page
    function showLoginPage() {
      document.getElementById('login-page').style.display = 'flex';
      document.getElementById('dashboard-page').style.display = 'none';
      document.querySelector('.sidebar').style.display = 'none';
      document.querySelector('header').style.display = 'none';
      isLoggedIn = false;
    }

    // Show dashboard
    function showDashboard() {
      document.getElementById('login-page').style.display = 'none';
      document.getElementById('dashboard-page').style.display = 'block';
      document.querySelector('.sidebar').style.display = 'flex';
      document.querySelector('header').style.display = 'flex';
      isLoggedIn = true;
      updateUserDisplay();
      refreshAll();
    }

    // Handle login form submission
    document.getElementById('loginForm')?.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      const role = document.getElementById('loginRole').value;
      const errorDiv = document.getElementById('loginError');

      if (!username || !password || !role) {
        errorDiv.textContent = 'Please fill in all fields';
        errorDiv.style.display = 'block';
        return;
      }

      // Simple demo authentication (admin/demo)
      if (username === 'admin' && password === 'demo') {
        currentUser = {
          username: username,
          name: username.charAt(0).toUpperCase() + username.slice(1),
          role: role,
          loginTime: new Date().toISOString()
        };
        
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        errorDiv.style.display = 'none';
        
        // Clear form
        document.getElementById('loginForm').reset();
        
        showDashboard();
      } else {
        errorDiv.textContent = 'Invalid credentials. Use admin/demo';
        errorDiv.style.display = 'block';
        setTimeout(() => {
          errorDiv.style.display = 'none';
        }, 3000);
      }
    });

    // Logout function
    function logout() {
      localStorage.removeItem('currentUser');
      currentUser = null;
      isLoggedIn = false;
      document.getElementById('loginForm').reset();
      showLoginPage();
    }

    // Update user display in sidebar
    function updateUserDisplay() {
      if (currentUser) {
        const avatar = document.querySelector('.avatar');
        const nameEl = document.querySelector('.uinfo .name');
        const roleEl = document.querySelector('.uinfo .role');
        const userBtn = document.getElementById('userBtn');

        if (avatar) avatar.textContent = (currentUser.name || currentUser.username).substring(0, 2).toUpperCase();
        if (nameEl) nameEl.textContent = currentUser.name || currentUser.username;
        if (roleEl) roleEl.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
        if (userBtn) userBtn.textContent = `${currentUser.name || currentUser.username} (${currentUser.role})`;

        // Show/hide buttons based on role
        const newBtn = $('#newTxnBtn');
        const repBtn = $('#reportDefectBtn');
        if (newBtn) newBtn.style.display = canInput() ? '' : 'none';
        if (repBtn) repBtn.style.display = canInput() ? '' : 'none';
      }
    }

    // Role-based permissions
    function canEdit() { 
      return isLoggedIn && currentUser && (currentUser.role === 'admin' || currentUser.role === 'student'); 
    }
    
    function canInput() { 
      return isLoggedIn && currentUser && (currentUser.role === 'employee' || currentUser.role === 'student'); 
    }

    // Add logout button listener
    document.getElementById('userBtn')?.addEventListener('click', () => {
      if (confirm('Are you sure you want to log out?')) {
        logout();
      }
    });

    // Initialize on page load
    checkLoginStatus();

    // find a material by SKU (case-insensitive)
    function findMaterialBySKU(sku){
      if(!sku) return null;
      return materials.find(m => String(m.sku).toLowerCase() === String(sku).toLowerCase()) || null;
    }

    // --- Page nav ---
    const pages = { dashboard: $("#dashboard-page"), materials: $("#materials-page"), transactions: $("#transactions-page"), defects: $("#defects-page"), settings: $("#settings-page"), "sap-data": $("#sap-data-page"), "comparison": $("#comparison-page"), "linear-programming": $("#linear-programming-page"), "material-descriptions": $("#material-descriptions-page") };
    const menuButtons = $$("#menu button");

    function filterTransactionsBySKU(sku) {
      $("#transactionsSearch").value = sku;
      showPage('transactions');
    }

    function showPage(key){
      Object.values(pages).forEach(p=>p.style.display='none');
      pages[key].style.display='';
      menuButtons.forEach(b=>b.classList.toggle('active', b.dataset.page===key));
      const titleMap = { dashboard:"Inventory Dashboard", materials:"Material Records", transactions:"Material Transactions", defects:"Defects Log Reports", settings:"Settings", "sap-data":"SAP Data", "comparison":"Comparison", "linear-programming":"Linear Programming", "material-descriptions":"Material Descriptions" };
      $("#pageTitle").textContent = titleMap[key] || "Inventory Pro";
      document.getElementById('sidebar').classList.remove('open');
      if (key === 'sap-data') buildSapInventoryTable();
      if (key === 'comparison') buildComparisonTables();
      if (key === 'linear-programming') {
        buildLpMaterialsTable();
        loadTargetDemand();
        calculateDemandTracking();
        // Update auto-update button status
        updateAutoUpdateButton();
      } else {
        // Stop LP auto-update when leaving the page
        stopLpAutoUpdate();
      }
      if (key === 'transactions') {
        // Refresh transactions table with current filters
        const searchTerm = $("#transactionsSearch")?.value.trim() || '';
        const typeFilter = $("#transactionsTypeFilter")?.value || '';
        const dateFilter = $("#transactionsDateFilter")?.value || '';
        buildTransactions(false, searchTerm, typeFilter, dateFilter);
        buildTransactionVolumeChart();
      }
      if (key === 'defects') {
        // Refresh defects table with current filters
        const searchTerm = $("#defectsSearch")?.value.trim() || '';
        const dateFilter = $("#defectsDateFilter")?.value || '';
        buildDefectsTable(searchTerm, '', dateFilter);
        buildDefectsByTypeChart();
      }
      if (key === 'materials') {
        // Refresh materials table with current search
        const searchTerm = $("#materialsSearch")?.value.trim() || '';
        buildMaterialsTable2(searchTerm);
        buildStockDistributionChart();
      }
      if (key === 'material-descriptions') {
        // Build material descriptions with search
        const searchTerm = $("#descriptionsSearch")?.value.trim() || '';
        buildMaterialDescriptionsTable(searchTerm);
      }
    }
    // --- Product library helpers ---
    function populateProductSelect(el, includeOther=true){
      if(!el) return;
      const opts = productLibrary.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');
      el.innerHTML = (opts || '') + (includeOther ? '<option value="__other__">Other‚Ä¶</option>' : '');
    }

    function updateProductSelects(){
      const ids = ['#inline_txnProductSelect', '#eTxnProductSelect', '#totalMaterialsFilter'];
      ids.forEach(id => { const el = $(id); if(el) populateProductSelect(el, id !== '#totalMaterialsFilter'); });  // for filter, no other
      // update any inline row selects if present
      Array.from(document.querySelectorAll('select.inline-e-select')).forEach(el => populateProductSelect(el));
    }
    menuButtons.forEach(btn => btn.addEventListener('click', ()=> showPage(btn.dataset.page)));
    $("#btnToggle").addEventListener('click', ()=> document.getElementById('sidebar').classList.toggle('open'));
    $("#themeToggle").addEventListener('change', toggleTheme);

    // Theme toggle function
    function toggleTheme() {
      const checkbox = document.getElementById('themeToggle');
      const body = document.body;
      const isDark = checkbox.checked;
      if (isDark) {
        body.classList.add('dark');
      } else {
        body.classList.remove('dark');
      }
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    // Load saved theme on page load
    const savedTheme = localStorage.getItem('theme');
    const checkbox = document.getElementById('themeToggle');
    if (savedTheme === 'dark') {
      document.body.classList.add('dark');
      checkbox.checked = true;
    } else {
      checkbox.checked = false;
    }

    // Defects page search and filters
    $("#defectsSearch")?.addEventListener('input', (e) => {
      const searchTerm = e.target.value.trim();
      const dateFilter = $("#defectsDateFilter")?.value || '';
      buildDefectsTable(searchTerm, '', dateFilter);
    });

    $("#defectsDateFilter")?.addEventListener('change', (e) => {
      const searchTerm = $("#defectsSearch")?.value.trim() || '';
      const dateFilter = e.target.value;
      buildDefectsTable(searchTerm, '', dateFilter);
    });

    // Transactions page search and filters
    $("#transactionsSearch")?.addEventListener('input', (e) => {
      const searchTerm = e.target.value.trim();
      const typeFilter = $("#transactionsTypeFilter")?.value || '';
      const dateFilter = $("#transactionsDateFilter")?.value || '';
      buildTransactions(false, searchTerm, typeFilter, dateFilter);
    });

    $("#transactionsTypeFilter")?.addEventListener('change', (e) => {
      const searchTerm = $("#transactionsSearch")?.value.trim() || '';
      const typeFilter = e.target.value;
      const dateFilter = $("#transactionsDateFilter")?.value || '';
      buildTransactions(false, searchTerm, typeFilter, dateFilter);
    });

    $("#transactionsDateFilter")?.addEventListener('change', (e) => {
      const searchTerm = $("#transactionsSearch")?.value.trim() || '';
      const typeFilter = $("#transactionsTypeFilter")?.value || '';
      const dateFilter = e.target.value;
      buildTransactions(false, searchTerm, typeFilter, dateFilter);
    });

    // Materials page search
    $("#materialsSearch")?.addEventListener('input', (e) => {
      const searchTerm = e.target.value.trim();
      buildMaterialsTable2(searchTerm);
    });

    // Material Descriptions page search
    $("#descriptionsSearch")?.addEventListener('input', (e) => {
      const searchTerm = e.target.value.trim();
      buildMaterialDescriptionsTable(searchTerm);
    });

    // Threshold button click handler
    $("#thresholdBtn")?.addEventListener('click', () => {
      const currentThreshold = Number($("#defaultThreshold").value || 100);
      document.getElementById('thresholdInput').value = currentThreshold;
      document.getElementById('thresholdModal').style.display = 'flex';
    });
    
    // Close modal on backdrop click
    document.getElementById('thresholdModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'thresholdModal') {
        e.target.style.display = 'none';
      }
    });
    
    // Increment threshold button
    $("#incrementThreshold")?.addEventListener('click', () => {
      const input = document.getElementById('thresholdInput');
      input.value = Math.max(0, Number(input.value) + 10);
    });
    
    // Decrement threshold button
    $("#decrementThreshold")?.addEventListener('click', () => {
      const input = document.getElementById('thresholdInput');
      input.value = Math.max(0, Number(input.value) - 10);
    });
    
    // Save threshold button
    $("#saveThreshold")?.addEventListener('click', () => {
      const newThreshold = Math.max(0, Number(document.getElementById('thresholdInput').value));
      $("#defaultThreshold").value = newThreshold;
      document.getElementById('thresholdDisplay').textContent = newThreshold;
      saveState();
      buildStockDistributionChart();
      document.getElementById('thresholdModal').style.display = 'none';
    });

    // Go to Material Records button
    $("#viewMaterialRecordsBtn")?.addEventListener('click', () => {
      showPage('materials');
    });

    // Remove all imports button
    $("#removeAllImports")?.addEventListener('click', () => {
      if (confirm('Remove all imported SAP data? This cannot be undone.')) {
        sapInventory = [];
        nextImportNo = 1;
        saveState();
        buildSapInventoryTable();
        buildComparisonTables();
        alert('All imports removed.');
      }
    });

    // SAP filter buttons
    $("#applySapFilter")?.addEventListener('click', () => {
      const filter = $("#sapFilter").value.trim();
      buildSapInventoryTable(filter);
    });

    $("#clearSapFilter")?.addEventListener('click', () => {
      $("#sapFilter").value = '';
      buildSapInventoryTable();
    });

    // Filter for total materials available
    $("#totalMaterialsFilter").addEventListener('change', ()=>{
      const filterProduct = $("#totalMaterialsFilter").value;
      $("#materialsReceived").textContent = computeTotalAvailable(filterProduct);
    });

    // --- Build UI lists/tables ---
    function statusForStock(stock){
      // handle missing stock explicitly
      if(stock === null || stock === undefined || String(stock).trim() === '') return {label:'No Stock', cls:'gray'};
      const n = Number(stock || 0);
      if(n === 0) return {label:'Out of Stock', cls:'red'};
      if(n < Number($("#defaultThreshold").value || 100)) return {label:'Low Stock', cls:'orange'};
      return {label:'In Stock', cls:'green'};
    }

    function buildMaterialsTable(tableEl, data){
      const tbody = tableEl.querySelector('tbody');
      tbody.innerHTML = "";
      // For the main materials table we show a material per row.
      // For the Materials Records page (materialsTable2) we also include related Transactions and Defects rows beneath each material so the view reflects updates.
      const includeWho = tableEl && tableEl.id !== 'materialsTable2';
      data.forEach(m=>{
        // Calculate totals
        const totalTxnQty = transactions.filter(t => (t.sku||'').toLowerCase() === (m.sku||'').toLowerCase()).reduce((sum, t) => sum + (Number(t.qty) || 0), 0);
        const totalDefQty = defects.filter(d => (d.sku||'').toLowerCase() === (m.sku||'').toLowerCase()).reduce((sum, d) => sum + (Number(d.qty) || 0), 0);
        const adjustedStock = (m.stock || 0) - totalDefQty;
        // Material row
        const tr = document.createElement('tr');
        if(includeWho){
          tr.innerHTML = `
            <td>Material</td>
            <td></td>
            <td>${escapeHtml(m.sku)}</td>
            <td>${escapeHtml(m.product)}</td>
            <td>${ (m.stock===null||m.stock===undefined||String(m.stock).trim()==='') ? '-' : m.stock }</td>
            <td>${(() => { const s = statusForStock(m.stock); return `<span class="badge ${s.cls}">${s.label}</span>`; })()}</td>
            <td>${m.updated || ''}</td>
            <td style="text-align:right">
              <div class="actions">
                <button class="small btn ghost view-btn" data-id="${m.id}">View</button>
                ${ canEdit() ? `<button class="small btn ghost edit-material" data-id="${m.id}">Edit</button>` : '' }
                ${ canEdit() ? `<button class="small btn ghost delete-material" data-id="${m.id}">Delete</button>` : '' }
              </div>
            </td>
          `;
        } else {
          // Materials Records page
          tr.innerHTML = `
            <td>${escapeHtml(m.sku)}</td>
            <td>${escapeHtml(m.product)}</td>
            <td>${m.stock || 0}</td>
            <td>${m.cost || 0}</td>
            <td>${ ((m.stock || 0) * (m.cost || 0)).toFixed(2) }</td>
            <td>${(() => { const s = statusForStock(m.stock || 0); return `<span class="badge ${s.cls}">${s.label}</span>`; })()}</td>
            <td>${m.updated || ''}</td>
            <td style="text-align:right">
              <div class="actions">
                <button class="small btn ghost view-btn" data-id="${m.id}">View</button>
                ${ canEdit() ? `<button class="small btn ghost edit-material" data-id="${m.id}">Edit</button>` : '' }
                ${ canEdit() ? `<button class="small btn ghost delete-material" data-id="${m.id}">Delete</button>` : '' }
              </div>
            </td>
          `;
        }
        tbody.appendChild(tr);
      });
    }

    function buildMaterialsTable2(searchTerm=''){
      // Filter materials based on search term
      let filteredMaterials = materials.filter(m => {
        if (!searchTerm) return true;
        // Search by code/SKU, description/product, or category
        return (m.sku && m.sku.toLowerCase().includes(searchTerm.toLowerCase())) ||
               (m.product && m.product.toLowerCase().includes(searchTerm.toLowerCase())) ||
               (m.category && m.category.toLowerCase().includes(searchTerm.toLowerCase())) ||
               (m.description && m.description.toLowerCase().includes(searchTerm.toLowerCase()));
      });
      
      buildMaterialsTable($("#materialsTable2"), filteredMaterials);
    }
    function buildMaterialsTableMain(){
      buildMaterialsTable($("#materialsTable"), materials);
    }

    let lpAutoUpdateTimer = null;
    let lpAutoUpdateEnabled = true;

    function buildLpMaterialsTable(){
      const tbody = $("#lpMaterialsTbody");
      tbody.innerHTML = "";
      // Use all materials from Material Records with same calculations
      materials.forEach(m => {
        // Calculate adjusted stock (same as Material Records: stock minus defects)
        const totalDefQty = defects.filter(d => (d.sku||'').toLowerCase() === (m.sku||'').toLowerCase()).reduce((sum, d) => sum + (Number(d.qty) || 0), 0);
        const adjustedStock = (m.stock || 0) - totalDefQty;

        let cost = m.cost || 0;
        if (cost === 0 && skuCostMap[m.sku]) {
          cost = skuCostMap[m.sku];
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(m.product)}</td>
          <td><input type="number" value="${m.stock || 0}" data-sku="${m.sku}" data-field="stock"></td>
          <td><input type="number" step="0.01" value="${cost}" data-sku="${m.sku}" data-field="cost"></td>
        `;
        tbody.appendChild(tr);
      });

      // Add event listeners to inputs for automatic calculation and data updates
      const inputs = tbody.querySelectorAll('input');
      inputs.forEach(input => {
        input.addEventListener('input', (e) => {
          // Update the materials array
          const sku = e.target.getAttribute('data-sku');
          const field = e.target.getAttribute('data-field');
          const value = field === 'cost' ? parseFloat(e.target.value) || 0 : parseInt(e.target.value) || 0;

          const material = materials.find(m => (m.sku || '').toLowerCase() === sku.toLowerCase());
          if (material) {
            material[field] = value;
            material.updated = new Date().toISOString().slice(0,10);
            saveState();
            // Refresh related tables
            buildMaterialsTable2();
          }

          // Calculate LP results
          calculate();
        });
      });

      // Also add listener to demand input
      const demandInput = $('#demandInput');
      if (demandInput) {
        demandInput.addEventListener('input', calculate);
      }

      // Start auto-update timer if enabled
      if(lpAutoUpdateEnabled){
        startLpAutoUpdate();
      }

      // Calculate immediately after building the table
      calculate();
    }

    function startLpAutoUpdate(){
      // Clear any existing timer
      if(lpAutoUpdateTimer) clearInterval(lpAutoUpdateTimer);

      // Only start if auto-update is enabled
      if(lpAutoUpdateEnabled){
        // Auto-update allocation results every 5 seconds
        lpAutoUpdateTimer = setInterval(() => {
          // Only update if LP page is currently visible
          if(pages['linear-programming'].style.display !== 'none'){
            calculate();
          }
        }, 5000);
      }
    }

    function stopLpAutoUpdate(){
      if(lpAutoUpdateTimer){
        clearInterval(lpAutoUpdateTimer);
        lpAutoUpdateTimer = null;
      }
    }

    function toggleAutoUpdate(){
      lpAutoUpdateEnabled = !lpAutoUpdateEnabled;

      if(lpAutoUpdateEnabled){
        startLpAutoUpdate();
        $('#autoUpdateStatus').textContent = 'ON';
        $('#autoUpdateBtn').classList.remove('ghost');
        showToast('Auto-update enabled', {timeout:2000});
      } else {
        stopLpAutoUpdate();
        $('#autoUpdateStatus').textContent = 'OFF';
        $('#autoUpdateBtn').classList.add('ghost');
        showToast('Auto-update disabled', {timeout:2000});
      }
    }

    function updateAutoUpdateButton(){
      const statusEl = $('#autoUpdateStatus');
      const btnEl = $('#autoUpdateBtn');

      if(statusEl && btnEl){
        statusEl.textContent = lpAutoUpdateEnabled ? 'ON' : 'OFF';
        if(lpAutoUpdateEnabled){
          btnEl.classList.remove('ghost');
        } else {
          btnEl.classList.add('ghost');
        }
      }
    }

    function buildSapInventoryTable(filter = ''){
      const container = $("#sap-data-page .panel:nth-child(2)");
      // Clear existing content except the header
      const header = container.querySelector('div[style*="display:flex"]');
      const style = container.querySelector('style');
      container.innerHTML = '';
      if (header) container.appendChild(header);
      if (style) container.appendChild(style);

      // Group by importNo
      const grouped = sapInventory.reduce((acc, item) => {
        const no = item.importNo || 'Unknown';
        if (!acc[no]) acc[no] = [];
        acc[no].push(item);
        return acc;
      }, {});

      // Sort by importNo descending
      let sortedNos = Object.keys(grouped).sort((a,b) => Number(b) - Number(a));

      // Apply filter
      if (filter) {
        sortedNos = sortedNos.filter(no => no.toString().includes(filter));
      }

      sortedNos.forEach(no => {
        const items = grouped[no];
        const card = document.createElement('div');
        card.className = 'card';
        card.style.marginBottom = '24px';
        card.style.padding = '20px';
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <h4>${isNaN(no) ? 'Import Date: ' + no : 'Import No. ' + no}</h4>
            <button class="btn small remove-import" data-key="${no}">Remove Import</button>
          </div>
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr>
                <th>Item No.</th>
                <th>Item Description</th>
                <th>Whse</th>
                <th>In-Whse Qty</th>
                <th>Counted</th>
                <th>Issued</th>
                <th>Counted Qty</th>
                <th>Variance</th>
                <th>Rejection</th>
                <th>BOM</th>
                <th>UoM</th>
                <th>Cost</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        `;
        const tbody = card.querySelector('tbody');
        items.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(item.itemNo || '')}</td>
            <td>${escapeHtml(item.description || '')}</td>
            <td>${escapeHtml(item.whse || '')}</td>
            <td>${item.inWhseQty || ''}</td>
            <td>${item.counted || ''}</td>
            <td>${item.issued || ''}</td>
            <td>${item.countedQty || ''}</td>
            <td>${item.variance || ''}</td>
            <td>${item.rejection || ''}</td>
            <td>${escapeHtml(item.bom || '')}</td>
            <td>${escapeHtml(item.uom || '')}</td>
            <td>${item.cost || ''}</td>
          `;
          tbody.appendChild(tr);
        });
        container.appendChild(card);
      });

      // Add event listener for remove buttons using event delegation
      container.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-import')) {
          const key = e.target.getAttribute('data-key');
          if (confirm(`Remove all items from Import ${key}?`)) {
            sapInventory = sapInventory.filter(item => (item.importNo || item.importDate) != key);
            saveState();
            buildSapInventoryTable();
            buildComparisonTables();
            alert('Import removed.');
          }
        }
      });
    }

    function buildComparisonTables(){
      const tbody1 = document.getElementById('table1tbody');
      tbody1.innerHTML = '';
      const tbody2 = document.getElementById('table2tbody');
      tbody2.innerHTML = '';

      // Compute totals from transactions
      const totals = {};
      transactions.forEach(t => {
        if (!totals[t.sku]) totals[t.sku] = { received: 0, issued: 0 };
        if (String(t.type).toLowerCase() === 'received') totals[t.sku].received += t.qty || 0;
        else if (String(t.type).toLowerCase() === 'issued') totals[t.sku].issued += t.qty || 0;
      });

      // Compute defect totals for rejection
      const defectTotals = {};
      defects.forEach(d => {
        if (!defectTotals[d.sku]) defectTotals[d.sku] = 0;
        defectTotals[d.sku] += d.qty || 0;
      });

      let matchCount = 0;
      let mismatchCount = 0;
      let variances = [];

      sapInventory.forEach(item => {
        // Table 1
        const tr1 = document.createElement('tr');
        tr1.innerHTML = `
          <td>${escapeHtml(item.itemNo || '')}</td>
          <td>${escapeHtml(item.description || '')}</td>
          <td>${escapeHtml(item.whse || '')}</td>
          <td>${item.inWhseQty || ''}</td>
          <td>${item.counted || ''}</td>
          <td>${item.issued || ''}</td>
          <td>${item.countedQty || ''}</td>
          <td>${item.variance || ''}</td>
          <td>${item.rejection || ''}</td>
          <td>${escapeHtml(item.bom || '')}</td>
          <td>${escapeHtml(item.uom || '')}</td>
          <td>${item.cost || ''}</td>
        `;
        tbody1.appendChild(tr1);

        // Table 2
        const sku = item.itemNo;
        const totalReceived = totals[sku]?.received || 0;
        const totalIssued = totals[sku]?.issued || 0;
        const rejection = defectTotals[sku] || 0;
        const variance = totalReceived - totalIssued;
        const status = variance === rejection ? "Match" : "Mismatch";
        const tr2 = document.createElement('tr');
        tr2.innerHTML = `
          <td>${escapeHtml(item.itemNo || '')}</td>
          <td>${escapeHtml(item.description || '')}</td>
          <td>${escapeHtml(item.whse || '')}</td>
          <td>${item.inWhseQty || ''}</td>
          <td>${item.counted || ''}</td>
          <td>${item.issued || ''}</td>
          <td onclick="filterTransactionsBySKU('${sku}')" style="cursor:pointer; color:blue;">${totalReceived}</td>
          <td onclick="filterTransactionsBySKU('${sku}')" style="cursor:pointer; color:blue;">${totalIssued}</td>
          <td>${rejection}</td>
          <td>${variance}</td>
          <td>${status}</td>
          <td>${escapeHtml(item.bom || '')}</td>
          <td>${escapeHtml(item.uom || '')}</td>
          <td>${item.cost || ''}</td>
        `;
        tbody2.appendChild(tr2);

        // Collect data for charts
        if (status === 'Match') matchCount++;
        else mismatchCount++;
        variances.push({sku: sku, variance: variance});
      });

      // Sort variances by absolute value descending and take top 10
      variances.sort((a, b) => Math.abs(b.variance) - Math.abs(a.variance));
      const topVariances = variances.slice(0, 10);

      // Destroy previous charts if exist
      if (window.statusChart) window.statusChart.destroy();
      if (window.varianceChart) window.varianceChart.destroy();

      // Create charts
      // Status Pie Chart
      const statusCtx = document.getElementById('statusPieChart').getContext('2d');
      window.statusChart = new Chart(statusCtx, {
        type: 'pie',
        data: {
          labels: ['Match', 'Mismatch'],
          datasets: [{
            data: [matchCount, mismatchCount],
            backgroundColor: ['#10b981', '#ef4444'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Status Distribution'
            }
          }
        }
      });

      // Variance Bar Chart
      const varianceCtx = document.getElementById('varianceBarChart').getContext('2d');
      window.varianceChart = new Chart(varianceCtx, {
        type: 'bar',
        data: {
          labels: topVariances.map(v => v.sku),
          datasets: [{
            label: 'Variance',
            data: topVariances.map(v => v.variance),
            backgroundColor: topVariances.map(v => v.variance >= 0 ? '#10b981' : '#ef4444'),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: 'Top 10 Variances by Item'
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // Stock Distribution Chart for Materials page
    function buildStockDistributionChart(){
      const ctx = document.getElementById('stockDistributionChart');
      if (!ctx) return;
      
      if (window.stockDistributionChartInstance) window.stockDistributionChartInstance.destroy();
      
      const topMaterials = materials.slice(0, 10);
      const threshold = Number($("#defaultThreshold").value || 100);
      
      // Update threshold display
      document.getElementById('thresholdDisplay').textContent = threshold;
      
      // Color code bars based on threshold
      const barColors = topMaterials.map(m => {
        const stock = m.stock || 0;
        return stock < threshold ? '#ef4444' : '#10b981';
      });
      
      window.stockDistributionChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: topMaterials.map(m => m.sku),
          datasets: [{
            label: 'Stock Quantity',
            data: topMaterials.map(m => m.stock || 0),
            backgroundColor: barColors,
            borderWidth: 0
          },
          {
            label: 'Threshold',
            data: Array(topMaterials.length).fill(threshold),
            type: 'line',
            borderColor: '#f59e0b',
            borderWidth: 2,
            borderDash: [5, 5],
            fill: false,
            pointRadius: 0,
            tension: 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'Stock Distribution (Top 10 Materials) - Red: Low Stock | Green: In Stock' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  if (context.dataset.label === 'Threshold') {
                    return 'Threshold: ' + context.parsed.y + ' units';
                  }
                  const stock = context.parsed.y;
                  const status = stock < threshold ? 'Low Stock' : 'In Stock';
                  return context.dataset.label + ': ' + stock + ' (' + status + ')';
                }
              }
            }
          },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Transaction Volume Chart for Transactions page
    function buildTransactionVolumeChart(){
      const ctx = document.getElementById('transactionVolumeChart');
      if (!ctx) return;
      
      if (window.transactionVolumeChartInstance) window.transactionVolumeChartInstance.destroy();
      
      const received = transactions.filter(t => t.type === 'Received').length;
      const issued = transactions.filter(t => t.type === 'Issued').length;
      
      window.transactionVolumeChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Received', 'Issued'],
          datasets: [{
            data: [received, issued],
            backgroundColor: ['#10b981', '#f59e0b'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'Transaction Volume Distribution' }
          }
        }
      });
    }

    // Defects by Type Chart for Defects page
    function buildDefectsByTypeChart(){
      const ctx = document.getElementById('defectsByTypeChart');
      if (!ctx) return;
      
      if (window.defectsByTypeChartInstance) window.defectsByTypeChartInstance.destroy();
      
      const defectTypes = {};
      defects.forEach(d => {
        defectTypes[d.type] = (defectTypes[d.type] || 0) + 1;
      });
      
      const types = Object.keys(defectTypes);
      const counts = Object.values(defectTypes);
      const colors = ['#ef4444', '#f59e0b', '#3b82f6', '#10b981', '#8b5cf6'];
      
      window.defectsByTypeChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: types,
          datasets: [{
            label: 'Defect Count',
            data: counts,
            backgroundColor: colors.slice(0, types.length),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'Defects by Type' }
          },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // helper to format numeric cost values as currency
    function formatCurrency(val){
      if(val === null || val === undefined || isNaN(Number(val))) return '-';
      try{ return Number(val).toLocaleString(undefined, {style:'currency', currency:'USD', minimumFractionDigits:2}); }
      catch(e){ return '$' + Number(val).toFixed(2); }
    }

    function buildTransactions(short=true, searchTerm='', typeFilter='', dateFilter=''){
      const table = short ? $("#transactionsTable") : $("#transactionsTableFull");
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = "";
      
      // Filter transactions based on search and filters
      let filteredTransactions = transactions.filter(t => {
        // Search filter (by code/SKU, description/product, or category)
        const searchMatch = !searchTerm || 
          (t.sku && t.sku.toLowerCase().includes(searchTerm.toLowerCase())) ||
          (t.product && t.product.toLowerCase().includes(searchTerm.toLowerCase())) ||
          (findMaterialBySKU(t.sku) && findMaterialBySKU(t.sku).category && 
           findMaterialBySKU(t.sku).category.toLowerCase().includes(searchTerm.toLowerCase()));
        
        // Type filter
        const typeMatch = !typeFilter || t.type === typeFilter;
        
        // Date filter
        let dateMatch = true;
        if (dateFilter) {
          const today = new Date();
          const txnDate = new Date(t.date);
          
          switch(dateFilter) {
            case 'today':
              dateMatch = txnDate.toDateString() === today.toDateString();
              break;
            case 'week':
              const weekAgo = new Date(today);
              weekAgo.setDate(today.getDate() - 7);
              dateMatch = txnDate >= weekAgo;
              break;
            case 'month':
              const monthAgo = new Date(today);
              monthAgo.setMonth(today.getMonth() - 1);
              dateMatch = txnDate >= monthAgo;
              break;
          }
        }
        
        return searchMatch && typeMatch && dateMatch;
      });
      
      filteredTransactions.forEach(t=>{
        // no stock column in transaction rows (Material Records will show stock)
        const tr = document.createElement('tr');
        if(short){
          // Dashboard short view uses same columns but shows a compact view
          tr.innerHTML = `
            <td>${escapeHtml(t.type)}</td>
            <td>${escapeHtml(t.by || '')}</td>
            <td>${escapeHtml(t.sku)}</td>
            <td>${escapeHtml(t.product)}</td>
            <td>${t.qty}</td>
            <td>${skuCostMap[t.sku] !== undefined ? skuCostMap[t.sku] : '-'}</td>
            
            <td>${t.date}</td>
            <td style="text-align:right"><div class="actions">${ canEdit() ? `<button class="small btn ghost edit-transaction" data-id="${t.id}">Edit</button><button class="small btn ghost delete-transaction" data-id="${t.id}">Delete</button>` : '' }</div></td>
          `;
          // short view ‚Äì no side-effects here
        } else {
          // Full view -- columns: Type, By, Item No., Item description, QTY, Cost, Date
          const mat = findMaterialBySKU(t.sku);
          const stockLevel = mat ? mat.stock : 0;
          tr.innerHTML = `\
            <td>${escapeHtml(t.type)}</td>\
            <td>${escapeHtml(t.by || '')}</td>\
            <td>${escapeHtml(t.sku)}</td>\
            <td>${escapeHtml(t.product)}</td>\
            <td>${t.qty}</td>
            <td>${skuCostMap[t.sku] !== undefined ? skuCostMap[t.sku] : '-'}</td>
            <td>${stockLevel}</td>
            <td>${t.date}</td>\
            <td style="text-align:right"><div class="actions">${ canEdit() ? `<button class="small btn ghost edit-transaction" data-id="${t.id}">Edit</button><button class="small btn ghost delete-transaction" data-id="${t.id}">Delete</button>` : '' }</div></td>\
          `;
        }
        tbody.appendChild(tr);
      });

      // Add total row for full view
      if (!short && filteredTransactions.length > 0) {
        let sumQty = filteredTransactions.reduce((sum, t) => sum + t.qty, 0);
        let sumCost = filteredTransactions.reduce((sum, t) => sum + (skuCostMap[t.sku] || 0), 0);
        let stockLevel = '';
        if (filteredTransactions.length > 0) {
          const firstSku = filteredTransactions[0].sku;
          if (filteredTransactions.every(t => t.sku === firstSku)) {
            const mat = findMaterialBySKU(firstSku);
            stockLevel = mat ? mat.stock : 0;
          }
        }
        const totalTr = document.createElement('tr');
        totalTr.innerHTML = `
          <td colspan="4" style="font-weight: bold;">Total:</td>
          <td style="font-weight: bold; text-align: right;">${sumQty}</td>
          <td style="font-weight: bold; text-align: right;">${sumCost.toFixed(2)}</td>
          <td style="font-weight: bold; text-align: right;">${stockLevel}</td>
          <td></td>
          <td></td>
        `;
        tbody.appendChild(totalTr);
      }
    }

    function buildDefectsTable(searchTerm='', typeFilter='', dateFilter=''){
      const tbody = $("#defectsTable tbody");
      tbody.innerHTML = "";
      
      // Filter defects based on search and filters
      let filteredDefects = defects.filter(d => {
        // Search filter (by code/SKU, description/product, or category)
        const searchMatch = !searchTerm || 
          (d.sku && d.sku.toLowerCase().includes(searchTerm.toLowerCase())) ||
          (d.product && d.product.toLowerCase().includes(searchTerm.toLowerCase())) ||
          (findMaterialBySKU(d.sku) && findMaterialBySKU(d.sku).category && 
           findMaterialBySKU(d.sku).category.toLowerCase().includes(searchTerm.toLowerCase()));
        
        // Date filter
        let dateMatch = true;
        if (dateFilter) {
          const today = new Date();
          const defectDate = new Date(d.date);
          
          switch(dateFilter) {
            case 'today':
              dateMatch = defectDate.toDateString() === today.toDateString();
              break;
            case 'week':
              const weekAgo = new Date(today);
              weekAgo.setDate(today.getDate() - 7);
              dateMatch = defectDate >= weekAgo;
              break;
            case 'month':
              const monthAgo = new Date(today);
              monthAgo.setMonth(today.getMonth() - 1);
              dateMatch = defectDate >= monthAgo;
              break;
          }
        }
        
        return searchMatch && dateMatch;
      });
      
      filteredDefects.forEach((d, index)=>{
        const stBadge = d.status==='Open' ? 'red' : 'green';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(d.type)}</td>
          <td>${escapeHtml(d.by)}</td>
          <td>${escapeHtml(d.sku)}</td>
          <td>${escapeHtml(d.product)}</td>
          <td>${d.qty}</td>
          <td>${escapeHtml(d.note || '')}</td>
          <td>${d.date}</td>
          <td style="text-align:right"><div class="actions">${ canEdit() ? `<button class="small btn ghost edit-defect" data-index="${index}">Edit</button><button class="small btn ghost delete-defect" data-index="${index}">Delete</button><button class="small btn ghost resolve" data-index="${index}">Toggle</button>` : '' }</div></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function buildMaterialDescriptionsTable(searchTerm=''){
      const container = $("#materialDescriptionsContainer");
      if (!container) return;
      
      container.innerHTML = "";
      
      // Filter materials based on search term
      let filteredMaterials = materials.filter(m => {
        if (!searchTerm) return true;
        // Search by code/SKU, description/product, or category
        return (m.sku && m.sku.toLowerCase().includes(searchTerm.toLowerCase())) ||
               (m.product && m.product.toLowerCase().includes(searchTerm.toLowerCase())) ||
               (m.category && m.category.toLowerCase().includes(searchTerm.toLowerCase())) ||
               (m.description && m.description.toLowerCase().includes(searchTerm.toLowerCase()));
      });

      if (filteredMaterials.length === 0) {
        container.innerHTML = '<div style="color:var(--muted);padding:20px;text-align:center;">No materials found</div>';
        return;
      }

      filteredMaterials.forEach(m => {
        // Get related transactions
        const relatedTransactions = transactions.filter(t => (t.sku||'').toLowerCase() === (m.sku||'').toLowerCase());

        // Create detailed material view
        const card = document.createElement('div');
        card.className = 'card';
        card.style.padding = '16px';
        card.style.marginBottom = '12px';
        card.style.marginLeft = '0px';
        card.style.marginRight = '0px';
        card.style.marginTop = '0px';
        card.style.borderRadius = '8px';
        card.style.boxShadow = '0 1px 3px rgba(15, 23, 42, 0.04)';
        card.style.border = '1px solid var(--input-border)';
        
        card.innerHTML = `
          <div style="margin-bottom:24px;">
            <h4 style="font-size:12px;color:var(--muted);text-transform:uppercase;margin-bottom:8px;font-weight:600;">Material Details</h4>
            <h3 style="margin:0;font-size:24px;font-weight:700;">${escapeHtml(m.sku)}</h3>
          </div>
          
          <div style="margin-bottom:24px;">
            <h4 style="font-size:12px;color:var(--muted);text-transform:uppercase;margin-bottom:8px;font-weight:600;">Description</h4>
            <p style="margin:0;font-size:14px;line-height:1.5;">${escapeHtml(m.product)}</p>
          </div>
          
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:24px;margin-bottom:24px;padding:16px;background:var(--bg);border-radius:8px;">
            <div>
              <div style="font-size:11px;color:var(--muted);text-transform:uppercase;margin-bottom:6px;font-weight:600;">Unit</div>
              <div style="font-size:14px;font-weight:600;">${escapeHtml(m.qty || 'PCS')}</div>
            </div>
            <div>
              <div style="font-size:11px;color:var(--muted);text-transform:uppercase;margin-bottom:6px;font-weight:600;">Quantity</div>
              <div style="font-size:14px;font-weight:600;">${m.stock || 0} ${escapeHtml(m.qty || 'PCS')}</div>
            </div>
            <div>
              <div style="font-size:11px;color:var(--muted);text-transform:uppercase;margin-bottom:6px;font-weight:600;">Last Updated</div>
              <div style="font-size:14px;font-weight:600;">${m.updated || '-'}</div>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:24px;margin-bottom:24px;padding:16px;background:var(--bg);border-radius:8px;">
            <div>
              <div style="font-size:11px;color:var(--muted);text-transform:uppercase;margin-bottom:6px;font-weight:600;">QTY</div>
              <div style="font-size:14px;font-weight:600;">${m.stock || 0}</div>
            </div>
            <div>
              <div style="font-size:11px;color:var(--muted);text-transform:uppercase;margin-bottom:6px;font-weight:600;">Cost</div>
              <div style="font-size:14px;font-weight:600;">$${(m.cost || 0).toFixed(2)}</div>
            </div>
            <div>
              <div style="font-size:11px;color:var(--muted);text-transform:uppercase;margin-bottom:6px;font-weight:600;">Total Cost</div>
              <div style="font-size:14px;font-weight:600;">$${((m.stock || 0) * (m.cost || 0)).toFixed(2)}</div>
            </div>
            <div>
              <div style="font-size:11px;color:var(--muted);text-transform:uppercase;margin-bottom:6px;font-weight:600;">Stock Level</div>
              <div style="font-size:14px;font-weight:600;">${(() => { const s = statusForStock(m.stock); return `<span class="badge ${s.cls}">${s.label}</span>`; })()}</div>
            </div>
          </div>

          <div style="margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <h4 style="font-size:12px;color:var(--muted);text-transform:uppercase;margin:0;font-weight:600;">Transaction History</h4>
              <div style="display:flex;gap:8px;align-items:center;">
                <select class="filter-txn-type small input" data-material-id="${m.id}" style="font-size:11px;padding:4px 8px;width:120px;">
                  <option value="">All</option>
                  <option value="Received">Received</option>
                  <option value="Issued">Issued</option>
                </select>
                <button class="toggle-transactions small btn ghost" data-material-id="${m.id}" style="font-size:11px;padding:4px 8px;">Show</button>
              </div>
            </div>
            <div id="txn-container-${m.id}" style="overflow-x:auto;display:none;">
              <table style="width:100%;border-collapse:collapse;font-size:13px;">
                <thead>
                  <tr style="border-bottom:2px solid var(--input-border);">
                    <th style="text-align:left;padding:8px 0;color:var(--muted);font-weight:600;font-size:11px;text-transform:uppercase;">Type</th>
                    <th style="text-align:left;padding:8px 0;color:var(--muted);font-weight:600;font-size:11px;text-transform:uppercase;">By</th>
                    <th style="text-align:left;padding:8px 0;color:var(--muted);font-weight:600;font-size:11px;text-transform:uppercase;">Quantity</th>
                    <th style="text-align:left;padding:8px 0;color:var(--muted);font-weight:600;font-size:11px;text-transform:uppercase;">Date</th>
                    <th style="text-align:left;padding:8px 0;color:var(--muted);font-weight:600;font-size:11px;text-transform:uppercase;">Actions</th>
                  </tr>
                </thead>
                <tbody id="txn-tbody-${m.id}">
                  ${relatedTransactions.length === 0 ? '<tr><td colspan="5" style="padding:12px 0;text-align:center;color:var(--muted);">No transactions</td></tr>' : ''}
                </tbody>
              </table>
            </div>
          </div>

          <div style="display:flex;gap:8px;justify-content:flex-end;">
            <button class="btn small ghost edit-material-desc" data-id="${m.id}">Edit</button>
            <button class="btn small ghost view-all-txns" data-sku="${escapeHtml(m.sku)}">View All Transactions</button>
          </div>
        `;
        
        container.appendChild(card);

        // Populate transactions table for this material
        const tbody = container.querySelector(`#txn-tbody-${m.id}`);
        if (tbody && relatedTransactions.length > 0) {
          tbody.innerHTML = '';
          relatedTransactions.slice(0, 5).forEach(t => {
            const tr = document.createElement('tr');
            tr.style.borderBottom = '1px solid var(--input-border)';
            tr.innerHTML = `
              <td style="padding:8px 0;">${escapeHtml(t.type)}</td>
              <td style="padding:8px 0;">${escapeHtml(t.by || '-')}</td>
              <td style="padding:8px 0;">${t.qty}</td>
              <td style="padding:8px 0;">${t.date}</td>
              <td style="padding:8px 0;"><button class="small btn ghost edit-transaction" data-id="${t.id}">Edit</button></td>
            `;
            tbody.appendChild(tr);
          });
          if (relatedTransactions.length > 5) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="5" style="padding:8px 0;text-align:center;color:var(--accent);cursor:pointer;"><button class="view-all-txns small btn ghost" data-sku="${escapeHtml(m.sku)}" style="color:var(--accent);">View ${relatedTransactions.length - 5} more...</button></td>`;
            tbody.appendChild(tr);
          }
        }
      });

      // Add event listeners for action buttons
      container.addEventListener('click', (e) => {
        if (e.target.matches('.toggle-transactions')) {
          const materialId = e.target.getAttribute('data-material-id');
          const txnContainer = container.querySelector(`#txn-container-${materialId}`);
          const btn = e.target;
          
          if (txnContainer.style.display === 'none') {
            txnContainer.style.display = '';
            btn.textContent = 'Hide';
          } else {
            txnContainer.style.display = 'none';
            btn.textContent = 'Show';
          }
        }
        if (e.target.matches('.view-all-txns')) {
          const sku = e.target.getAttribute('data-sku');
          filterTransactionsBySKU(sku);
        }
        if (e.target.matches('.edit-material-desc')) {
          const id = Number(e.target.getAttribute('data-id'));
          const m = materials.find(x => x.id === id);
          if (m && canEdit()) {
            openCreateMaterialModal(m);
          } else if (!canEdit()) {
            alert('You do not have permission to edit materials.');
          }
        }
        if (e.target.matches('.edit-transaction')) {
          const txnId = Number(e.target.getAttribute('data-id'));
          const tx = transactions.find(t => t.id === txnId);
          if (tx && canEdit()) {
            // Open edit transaction modal
            openEditTransactionModal(tx);
          }
        }
      });

      // Add filter listener for transaction type
      container.addEventListener('change', (e) => {
        if (e.target.matches('.filter-txn-type')) {
          const materialId = e.target.getAttribute('data-material-id');
          const filterType = e.target.value;
          const tbody = container.querySelector(`#txn-tbody-${materialId}`);
          
          // Get all related transactions for this material
          const mat = materials.find(m => m.id === Number(materialId));
          if (!mat) return;
          
          let filtered = transactions.filter(t => (t.sku||'').toLowerCase() === (mat.sku||'').toLowerCase());
          if (filterType) {
            filtered = filtered.filter(t => t.type === filterType);
          }
          
          // Clear and rebuild tbody
          tbody.innerHTML = '';
          if (filtered.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="5" style="padding:12px 0;text-align:center;color:var(--muted);">No transactions</td>';
            tbody.appendChild(tr);
          } else {
            filtered.forEach(t => {
              const tr = document.createElement('tr');
              tr.style.borderBottom = '1px solid var(--input-border)';
              tr.innerHTML = `
                <td style="padding:8px 0;">${escapeHtml(t.type)}</td>
                <td style="padding:8px 0;">${escapeHtml(t.by || '-')}</td>
                <td style="padding:8px 0;">${t.qty}</td>
                <td style="padding:8px 0;">${t.date}</td>
                <td style="padding:8px 0;"><button class="small btn ghost edit-transaction" data-id="${t.id}">Edit</button></td>
              `;
              tbody.appendChild(tr);
            });
          }
        }
      });
    }

    function buildAlertsList(){
      const list = $("#alertsList");
      list.innerHTML = "";
      const threshold = Number($("#defaultThreshold").value || 100);
      const low = materials.filter(m => m.stock < threshold);
      low.forEach(m=>{
        const div = document.createElement('div');
        const leftColor = m.stock===0 ? 'var(--danger)' : 'var(--warning)';
        div.innerHTML = `
          <div class="alert-row" style="border-left-color:${leftColor}">
            <div>
              <div style="font-weight:700">${escapeHtml(m.product)}</div>
              <div style="font-size:13px;color:var(--muted)">Current: ${m.stock} ‚Ä¢ Threshold: ${threshold}</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="small btn create-po" data-sku="${m.sku}">Create PO</button>
              <button class="small btn ghost edit-material" data-id="${m.id}">Edit</button>
            </div>
          </div>
        `;
        list.appendChild(div.firstElementChild);
      });
      if(low.length===0) list.innerHTML = "<div style='color:var(--muted)'>No alerts</div>";
      $("#lowStockCount").textContent = low.filter(m=>m.stock>0).length;
      $("#oosCount").textContent = materials.filter(m=>m.stock===0).length;
    }

    function buildAlertsTable(){
      const tbody = $("#alertsTable tbody");
      tbody.innerHTML = "";
      alerts.forEach(a=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(a.sku)}</td>
          <td>${escapeHtml(a.product)}</td>
          <td>${a.qty}</td>
          <td>${(() => { const s = statusForStock(a.qty); return `<span class="badge ${s.cls}">${s.label}</span>`; })()}</td>
          <td>${a.date}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* History helpers */
    function addHistory(eventType, title, details, sku){
      const entry = { id: Date.now(), date: new Date().toISOString().slice(0,10), type: eventType, title: title || '', details: details || '', sku: sku || '' };
      history.unshift(entry);
      // cap history to a reasonable length (optional)
      if(history.length > 1000) history.length = 1000;
      saveState();
      return entry;
    }

    /* Toast + undo helpers */
    function showToast(message, opts={}){
      const root = document.getElementById('toastRoot');
      if(!root) return;
      const id = 'toast-' + Date.now();
      const el = document.createElement('div'); el.className = 'toast'; el.id = id;
      const msg = document.createElement('div'); msg.className='msg'; msg.textContent = message;
      const right = document.createElement('div');
      if(opts.actionLabel){
        const act = document.createElement('button'); act.className='action'; act.textContent = opts.actionLabel;
        act.addEventListener('click', ()=>{ try{ if(typeof opts.onAction === 'function') opts.onAction(); } catch(e){ console.warn(e); } root.removeChild(el); });
        right.appendChild(act);
      }
      const close = document.createElement('button'); close.className='action'; close.textContent='‚úï'; close.addEventListener('click', ()=> root.removeChild(el));
      right.appendChild(close);
      el.appendChild(msg); el.appendChild(right);
      root.appendChild(el);
      // show animation
      requestAnimationFrame(()=> el.classList.add('show'));
      // auto-remove after timeout
      const to = opts.timeout || 7000;
      setTimeout(()=>{ if(root.contains(el)) { el.classList.remove('show'); setTimeout(()=> root.removeChild(el), 220); } }, to);
      return el;
    }

    function undoLastTransaction(){
      if(!lastTransactionAction) { showToast('Nothing to undo'); return; }
      const act = lastTransactionAction;
      try{
        if(act.type === 'create'){
          // created a new transaction: remove and revert stock
          const tx = act.tx;
          // revert material change
          const m = findMaterialBySKU(tx.sku);
          if(m){
            if(String(tx.type).toLowerCase() === 'received') m.stock = Math.max(0, (m.stock || 0) - (Number(tx.qty) || 0));
            else if(String(tx.type).toLowerCase() === 'issued') m.stock = (m.stock || 0) + (Number(tx.qty) || 0);
            m.updated = new Date().toISOString().slice(0,10);
          }
          // remove tx
          transactions = transactions.filter(t => t.id !== tx.id);
          addHistory('Transaction', tx.product || tx.sku || 'Transaction', `Undo creation of ${tx.type} ${tx.qty} x ${tx.sku}`, tx.sku);
        } else if(act.type === 'delete'){
          // deleted tx: restore and reapply stock
          const tx = act.tx;
          transactions.unshift(tx);
          const m = findMaterialBySKU(tx.sku);
          if(m){
            if(String(tx.type).toLowerCase() === 'received') m.stock = (m.stock || 0) + (Number(tx.qty) || 0);
            else if(String(tx.type).toLowerCase() === 'issued') m.stock = Math.max(0, (m.stock || 0) - (Number(tx.qty) || 0));
            m.updated = new Date().toISOString().slice(0,10);
          }
          addHistory('Transaction', tx.product || tx.sku || 'Transaction', `Restored deleted ${tx.type} ${tx.qty} x ${tx.sku}`, tx.sku);
        } else if(act.type === 'edit'){
          // edit: revert to prev
          const prev = act.prev; const updated = act.new;
          const idx = transactions.findIndex(t => t.id === updated.id);
          if(idx !== -1){
            // rollback updated applied
            const updMat = findMaterialBySKU(updated.sku);
            if(updMat){
              if(String(updated.type).toLowerCase() === 'received') updMat.stock = Math.max(0, (updMat.stock || 0) - (Number(updated.qty) || 0));
              else if(String(updated.type).toLowerCase() === 'issued') updMat.stock = (updMat.stock || 0) + (Number(updated.qty) || 0);
              updMat.updated = new Date().toISOString().slice(0,10);
            }
            // apply prev
            const origMat = findMaterialBySKU(prev.sku);
            if(origMat){
              if(String(prev.type).toLowerCase() === 'received') origMat.stock = (origMat.stock || 0) + (Number(prev.qty) || 0);
              else if(String(prev.type).toLowerCase() === 'issued') origMat.stock = Math.max(0, (origMat.stock || 0) - (Number(prev.qty) || 0));
              origMat.updated = new Date().toISOString().slice(0,10);
            }
            transactions[idx] = prev;
            addHistory('Transaction', prev.product || prev.sku || 'Transaction', `Reverted changes to ${prev.sku}`, prev.sku);
          }
        }
        // done
        lastTransactionAction = null;
        saveState();
        refreshAll();
        showToast('Undone', {timeout:3000});
      } catch(e){ console.error('Undo failed', e); showToast('Undo failed'); }
    }

    // --- Charts (Chart.js) ---
    function computeTotalAvailable(filterProduct = ''){
      // Calculate total available from materials
      try{
        return materials.reduce((sum, m) => {
          if(filterProduct && m.product !== filterProduct) return sum;
          return sum + (m.stock || 0);
        }, 0);
      } catch(e){
        return 0;
      }
    }
    function computeDefectsCount30d(){
      const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-30);
      return defects.filter(d => new Date(d.date) >= cutoff).length;
    }

    // movement chart
    const movementCtx = document.getElementById('movementChart').getContext('2d');
    const movementChart = new Chart(movementCtx, {
      type:'line',
      data:{
        labels: Array.from({length:12}, (_,i) => `Day ${i+1}`),
        datasets:[
          {label:'Received', data:[50,80,40,120,90,70,60,80,100,40,60,90], tension:0.3},
          {label:'Issued', data:[30,20,60,40,70,30,50,60,40,20,30,40], tension:0.3}
        ]
      },
      options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true}}}
    });

    // Placeholder for future chart functions if needed

    // defects bar by type


    // --- Interactions: modals & actions ---
    function openModal(html){
      const root = $("#modalRoot");
      root.innerHTML = `<div class="modal-backdrop" id="modalBackdrop"><div class="modal">${html}</div></div>`;
      root.style.display = '';
      document.getElementById('modalBackdrop').addEventListener('click', (e)=> { if(e.target.id==='modalBackdrop') closeModal(); });
    }
    function closeModal(){ const root = $("#modalRoot"); root.innerHTML=""; root.style.display='none'; }

    // escape helper for safety when inserting text
    function escapeHtml(str){
      if(str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    // Add / Edit material modal
    function initAddMaterialButtons(){
      const addMaterialBtn = $("#addMaterialBtn");
      const addMaterialBtn2 = $("#addMaterialBtn2");
      [addMaterialBtn, addMaterialBtn2].forEach(b=>{
        if(!b) return;
        b.addEventListener('click', ()=> {
          openCreateMaterialModal();
        });
      });
    }

    function openCreateMaterialModal(existing){
      const isEdit = !!existing;
      openModal(`
        <h3>${isEdit ? 'Edit Material' : 'Create New Material'}</h3>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
          <label>Product name<input class="input" id="mProduct" placeholder="Product name" value="${existing ? escapeHtml(existing.product) : ''}"/></label>
          <label>SKU<input class="input" id="mSKU" placeholder="SKU" value="${existing ? escapeHtml(existing.sku) : ''}"/></label>
          <label>Category<input class="input" id="mCategory" placeholder="Category" value="${existing ? escapeHtml(existing.category) : ''}"/></label>
          <label>Description<input class="input" id="mDescription" placeholder="Description" value="${existing ? escapeHtml(existing.description) : ''}"/></label>
          <label>QTY<input class="input" id="mQty" placeholder="QTY" value="${existing ? escapeHtml(existing.qty) : ''}"/></label>
          <div style="display:flex;gap:8px">
            <input class="input" id="mStock" type="number" placeholder="Stock" value="${existing ? existing.stock : 0}"/>
            <input class="input" id="mLocation" placeholder="Location" value="${existing ? escapeHtml(existing.location) : ''}"/>
          </div>
          <label>Cost<input class="input" id="mCost" type="number" step="0.01" placeholder="Cost" value="${existing ? existing.cost : 0}" readonly /></label>
          <div class="actions" style="display:flex;justify-content:flex-end;gap:8px">
            <button class="btn ghost" id="cancelCreate">Cancel</button>
            <button class="btn" id="saveCreate">${isEdit ? 'Save Changes' : 'Create'}</button>
          </div>
        </div>
      `);

      $("#cancelCreate").addEventListener('click', closeModal);
      $("#saveCreate").addEventListener('click', ()=>{
        const id = existing ? existing.id : Date.now();
        const newMat = {
          id,
          product: $("#mProduct").value.trim() || "Unnamed",
          sku: $("#mSKU").value.trim() || `SKU${Date.now()}`,
          category: $("#mCategory").value.trim() || "",
          description: $("#mDescription").value.trim() || "",
          qty: $("#mQty").value.trim() || "",
          stock: Math.max(0, Number($("#mStock").value || 0)),
          location: $("#mLocation").value.trim() || "",
          cost: existing ? Number($("#mCost").value || 0) : (skuCostMap[$("#mSKU").value.trim()] || 0),
          updated: new Date().toISOString().slice(0,10)
        };
        if(existing){
          // update
          const idx = materials.findIndex(m => m.id === existing.id);
          if(idx>-1) materials[idx] = newMat;
          saveState();
          addHistory('Material', newMat.product || newMat.sku || 'Material', `Updated ${newMat.product} (${newMat.sku})`, newMat.sku);
        } else {
          if(isDuplicateMaterial(newMat)){
            showToast('Duplicate material detected ‚Äî skipped', {timeout:2500});
          } else {
            materials.unshift(newMat);
          }
          saveState();
          addHistory('Material', newMat.product || newMat.sku || 'Material', `Created ${newMat.product} (${newMat.sku})`, newMat.sku);
          alert(`New material created and added to Material Records: SKU ${newMat.sku} (${newMat.product})`);
        }
        refreshAll();
        closeModal();
      });
    }

    // Keep track of which material is currently shown in the modal (SKU)
    let currentViewingMaterialSKU = null;

    // Open the material view modal and include a transactions section filtered to this SKU
    function openMaterialView(mat){
      if(!mat) return;
      currentViewingMaterialSKU = mat.sku;
      openModal(`
        <h3>${escapeHtml(mat.product)}</h3>
        <div style="margin-top:8px">
          <div style="font-size:13px;color:var(--muted)">SKU: ${escapeHtml(mat.sku)} ¬∑ Category: ${escapeHtml(mat.category)}</div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <div style="flex:1">
              <div style="font-weight:700">Stock</div>
              <div style="font-size:20px">${mat.stock}</div>
            </div>
            <div style="flex:1">
              <div style="font-weight:700">Cost</div>
              <div>${mat.cost || 0}</div>
            </div>
            <div style="flex:1">
              <div style="font-weight:700">Total Cost</div>
              <div>${ ((mat.stock || 0) * (mat.cost || 0)).toFixed(2) }</div>
            </div>
            <div style="flex:1">
              <div style="font-weight:700">Date</div>
              <div>${mat.updated || '-'}</div>
            </div>
          </div>
          <h4 style="margin-top:14px">Transactions</h4>
          <div style="margin-top:6px;margin-bottom:8px">
            <select id="materialTxFilter" class="input" style="width:150px">
              <option value="">All Types</option>
              <option value="Received">Received</option>
              <option value="Issued">Issued</option>
              <option value="PO Created">PO Created</option>
            </select>
          </div>
          <div style="margin-top:6px;max-height:300px;overflow:auto">
              <table id="materialTxTable" style="width:100%;border-collapse:collapse">
                <thead><tr><th>Type</th><th>By</th><th>Item No.</th><th>Item description</th><th>QTY</th><th>Cost</th><th>Stock Level</th><th>Date</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
            <button class="btn ghost" id="closeView">Close</button>
          </div>
        </div>
      `);
      $("#closeView").addEventListener('click', ()=>{ currentViewingMaterialSKU = null; closeModal(); }, {once:true});
      $("#materialTxFilter").addEventListener('change', (e) => {
        renderMaterialModalTransactions(mat.sku, e.target.value);
      });
      renderMaterialModalTransactions(mat.sku);
    }

    // Render the list of transactions for the currently viewed material (by SKU)
    function renderMaterialModalTransactions(sku, typeFilter = ''){
      const tbody = document.querySelector('#materialTxTable tbody');
      if(!tbody) return;
      tbody.innerHTML = '';
      let items = transactions.filter(t => (t.sku||'').toLowerCase() === (sku||'').toLowerCase());
      if(typeFilter) items = items.filter(t => t.type === typeFilter);
      let totalQty = 0;
      let totalCost = 0;
      let totalStock = 0;
      items.forEach(t=>{
        const matForStock = findMaterialBySKU(t.sku);
        const stockVal = matForStock ? (matForStock.stock || 0) : 0;
        const costVal = skuCostMap[t.sku] !== undefined ? skuCostMap[t.sku] : 0;
        totalQty += Number(t.qty) || 0;
        totalCost += Number(costVal) || 0;
        totalStock += Number(stockVal) || 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(t.type)}</td>
          <td>${escapeHtml(t.by || '')}</td>
          <td>${escapeHtml(t.sku)}</td>
          <td>${escapeHtml(t.product)}</td>
          <td>${t.qty}</td>
          <td>${costVal}</td>
          <td>${stockVal}</td>
          <td>${t.date}</td>
          <td style="text-align:right"><div class="actions"><button class="small btn ghost edit-transaction" data-id="${t.id}">Edit</button><button class="small btn ghost delete-transaction" data-id="${t.id}">Delete</button></div></td>
        `;
        tbody.appendChild(tr);
      });
      // Add total row
      if(items.length > 0){
        const totalTr = document.createElement('tr');
        totalTr.style.fontWeight = 'bold';
        totalTr.innerHTML = `
          <td colspan="4" style="text-align:right;">Total:</td>
          <td>${totalQty}</td>
          <td>${totalCost.toFixed(2)}</td>
          <td>${totalStock}</td>
          <td colspan="2"></td>
        `;
        tbody.appendChild(totalTr);
      }
    }

    // Create PO and other action handlers
    document.body.addEventListener('click', (e)=>{
      // Create PO
      if(e.target.matches('.create-po')){
        const sku = e.target.dataset.sku;
        openModal(`
          <h3>Create Purchase Order</h3>
          <div style="margin-top:8px">
            <div style="font-size:13px;color:var(--muted)">SKU: ${escapeHtml(sku)}</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input class="input" id="poQty" type="number" value="100" />
              <button class="btn" id="createPoNow">Create PO</button>
            </div>
            <div style="margin-top:10px;text-align:right"><button class="btn ghost" id="cancelPo">Close</button></div>
          </div>
        `);
        $("#cancelPo").addEventListener('click', closeModal);
        $("#createPoNow").addEventListener('click', ()=>{
          const qty = Math.max(0, Number($("#poQty").value || 0));
          const poTx = {id: Date.now(), date:new Date().toISOString().slice(0,10), type:"PO Created", sku, product:"(auto)", qty, by:"System"};
          transactions.unshift(poTx);
          addHistory('PO', (findMaterialBySKU(sku)?.product) || sku, `PO for ${sku} qty ${qty}`, sku);
          saveState();
          refreshAll();
          closeModal();
          alert("Purchase Order created (demo).");
        });
      }

      // View material
      if(e.target.matches('.view-btn')){
        const id = Number(e.target.dataset.id);
        const m = materials.find(x=>x.id===id);
        if(!m) return;
        openMaterialView(m);
      }

      // Toggle defect status (requires edit permission)
      if(e.target.matches('.resolve')){
        if(!canEdit()){ alert('You do not have permission to modify defects.'); return; }
        const index = Number(e.target.dataset.index);
        const d = defects[index];
        if(d){
          d.status = d.status==='Open' ? 'Resolved' : 'Open';
          addHistory('Defect', d.product || d.sku || 'Defect', `${d.type} ${d.sku} (${d.product}) status: ${d.status}`, d.sku);
          saveState();
          refreshAll();
        }
      }

      // Edit defect
      if(e.target.matches('.edit-defect')){
        if(!canEdit()){ alert('You do not have permission to edit defects.'); return; }
        const index = Number(e.target.dataset.index);
        const d = defects[index];
        if(d){
          openModal(`
            <h3>Edit Defect</h3>
            <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
              <label>Type<input class="input" id="editDefType" value="${escapeHtml(d.type)}"/></label>
              <label>By<input class="input" id="editDefBy" value="${escapeHtml(d.by)}"/></label>
              <label>Item No.<input class="input" id="editDefSKU" value="${escapeHtml(d.sku)}"/></label>
              <label>Item description<input class="input" id="editDefProduct" value="${escapeHtml(d.product)}"/></label>
              <label>QTY<input class="input" id="editDefQty" type="number" value="${d.qty}"/></label>
              <label>Note<input class="input" id="editDefNote" value="${escapeHtml(d.note || '')}"/></label>
              <label>Date<input class="input" id="editDefDate" type="date" value="${d.date}"/></label>
              <div style="display:flex;gap:8px;justify-content:flex-end">
                <button class="btn ghost" id="cancelEditDef">Cancel</button>
                <button class="btn" id="saveEditDef">Save</button>
              </div>
            </div>
          `);
          $("#cancelEditDef").addEventListener('click', closeModal);
          $("#saveEditDef").addEventListener('click', ()=>{
            defects[index] = {
              type: $("#editDefType").value.trim() || 'Unknown',
              by: $("#editDefBy").value.trim() || 'User',
              sku: $("#editDefSKU").value.trim() || '-',
              product: $("#editDefProduct").value.trim() || 'Unknown',
              qty: Math.max(0, Number($("#editDefQty").value)),
              note: $("#editDefNote").value.trim() || '',
              date: $("#editDefDate").value,
              status: d.status
            };
            addHistory('Defect', defects[index].product || defects[index].sku || 'Defect', `Edited ${defects[index].type} on ${defects[index].sku}`, defects[index].sku);
            saveState();
            refreshAll();
            closeModal();
          });
        }
      }

      // Delete defect
      if(e.target.matches('.delete-defect')){
        if(!canEdit()){ alert('You do not have permission to delete defects.'); return; }
        const index = Number(e.target.dataset.index);
        const d = defects[index];
        if(d && confirm('Delete this defect?')){
          defects.splice(index, 1);
          addHistory('Defect', d.product || d.sku || 'Defect', `Deleted ${d.type} on ${d.sku}`, d.sku);
          saveState();
          refreshAll();
        }
      }

      // Edit material (from table or alerts)
      if(e.target.matches('.edit-material')){
        if(!canEdit()){ alert('You do not have permission to edit materials.'); return; }
        const id = Number(e.target.dataset.id);
        const m = materials.find(x=>x.id===id);
        if(!m) return;
        openCreateMaterialModal(m);
      }

      // Delete material
      if(e.target.matches('.delete-material')){
        if(!canEdit()){ alert('You do not have permission to delete materials.'); return; }
        const id = Number(e.target.dataset.id);
        if(!confirm('Delete this material? This action cannot be undone (demo).')) return;
        // remove material
        const removed = materials.find(m => m.id === id);
        materials = materials.filter(m => m.id !== id);
        saveState();
        if(removed) addHistory('Material', removed.product || removed.sku || 'Material', `Deleted ${removed.product} (${removed.sku})`, removed.sku);
        refreshAll();
      }

      // Edit transaction (inline)
      if(e.target.matches('.edit-transaction')){
        if(!canEdit()){ alert('You do not have permission to edit transactions.'); return; }
        const id = Number(e.target.dataset.id);
        startInlineEditTransaction(id, e.target);
      }

      // Delete transaction (revert stock effect)
      if(e.target.matches('.delete-transaction')){
        if(!canEdit()){ alert('You do not have permission to delete transactions.'); return; }
        const id = Number(e.target.dataset.id);
        const tx = transactions.find(x=>x.id===id);
        if(!tx) return;
        if(!confirm('Delete this transaction? This will attempt to revert its stock effect (demo).')) return;
        // rollback effect
        const m = findMaterialBySKU(tx.sku);
        if(m){
          if(String(tx.type).toLowerCase() === 'received'){
            m.stock = Math.max(0, m.stock - (Number(tx.qty) || 0));
          } else if(String(tx.type).toLowerCase() === 'issued'){
            m.stock = (m.stock || 0) + (Number(tx.qty) || 0);
          }
          m.updated = new Date().toISOString().slice(0,10);
        }
        transactions = transactions.filter(t => t.id !== id);
        addHistory('Transaction', tx.product || tx.sku || 'Transaction', `Deleted ${tx.type} ${tx.qty} x ${tx.sku} (${tx.product})`, tx.sku);
        saveState();
        refreshAll();
        // if we're currently viewing a material modal and it matches this tx sku, refresh its transactions table
        if(currentViewingMaterialSKU && currentViewingMaterialSKU.toLowerCase() === (tx.sku||'').toLowerCase()){
          renderMaterialModalTransactions(currentViewingMaterialSKU);
        }
      }
    });

    // New transaction modal
    // Open modal to log a new transaction (replaces inline toggle)
    $("#newTxnBtn")?.addEventListener('click', ()=>{
      showPage('transactions');
      openCreateTransactionModal();
    });

    // Modal-based create transaction form
    function openCreateTransactionModal(){
      openModal(`
        <h3>Log Transaction</h3>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
          <label>Type
            <select class="input" id="cTxnType"><option>Received</option><option>Issued</option><option>Adjustment</option></select>
          </label>
          <label>By<input class="input" id="cTxnBy" placeholder="Performed by" /></label>
          <label>SKU<input class="input" id="cTxnSKU" placeholder="SKU" readonly /></label>
          <label>Product
            <div style="display:flex;flex-direction:column;gap:6px">
              <select id="cTxnProductSelect" class="input"></select>
              <input class="input" id="cTxnProduct" placeholder="Product" style="display:none" />
            </div>
          </label>
          <label>Quantity<input class="input" id="cTxnQty" type="number" value="1" /></label>
          <label>Cost<input class="input" id="cTxnCost" type="number" step="0.01" placeholder="Cost" readonly /></label>
          <label>Date<input class="input" id="cTxnDate" type="date" value="${new Date().toISOString().slice(0,10)}" /></label>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn ghost" id="cancelCreateTxn">Cancel</button>
            <button class="btn" id="saveCreateTxn">Save</button>
          </div>
        </div>
      `);

      // populate product select
      const cSelect = $('#cTxnProductSelect');
      if(cSelect){
        cSelect.innerHTML = productLibrary.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('') + '<option value="__other__">Other...</option>';
      }

      // wire SKU -> product autofill when possible
      const cSku = $('#cTxnSKU');
      const cProd = $('#cTxnProduct');
      if(cSku && cProd){
        cSku.addEventListener('input', ()=>{
          const found = findMaterialBySKU(cSku.value.trim());
          if(found) {
            // select matching product option if exists, else show product input
            const idx = productLibrary.findIndex(p => String(p).toLowerCase() === String(found.product).toLowerCase());
            if(idx !== -1){ cSelect.value = productLibrary[idx]; cProd.style.display='none'; }
            else { cSelect.value='__other__'; cProd.style.display='block'; cProd.value = found.product; }
          }
          // auto-fill cost
          const cost = skuCostMap[cSku.value.trim()];
          if(cost !== undefined) $('#cTxnCost').value = cost;
        });
      }

      // wire product select -> SKU autofill
      if(cSelect){
        cSelect.addEventListener('change', ()=>{
          if(cSelect.value === '__other__'){ cProd.style.display='block'; cProd.value=''; }
          else { cProd.style.display='none'; cProd.value = cSelect.value; if(productSKUMap[cSelect.value]) cSku.value = productSKUMap[cSelect.value]; }
          // auto-fill cost
          const sku = productSKUMap[cSelect.value];
          if(sku) {
            const cost = skuCostMap[sku];
            if(cost !== undefined) $('#cTxnCost').value = cost;
          }
        });
      }

      // cancel/save handlers
      $('#cancelCreateTxn')?.addEventListener('click', ()=> closeModal(), {once:true});
      $('#saveCreateTxn')?.addEventListener('click', ()=>{
        try{
          const newT = {
            id: Date.now(),
            date: $('#cTxnDate').value,
            type: $('#cTxnType').value,
            sku: ($('#cTxnSKU').value||'').trim(),
            product: ($('#cTxnProductSelect') && $('#cTxnProductSelect').value !== '__other__') ? ($('#cTxnProductSelect').value||'').trim() : ($('#cTxnProduct').value||'').trim(),
            qty: Math.max(0, Number($('#cTxnQty').value || 0)),
            by: ($('#cTxnBy').value||'').trim() || 'User'
          };
          if(!newT.sku){
            if(newT.product && newT.product.trim()){
              newT.sku = (newT.product.trim().toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,6) || 'SKU') + Date.now().toString().slice(-4);
            } else { alert('Please provide SKU or Product name'); return; }
          }

          const mat = materials.find(m => (m.sku||'').toLowerCase() === (newT.sku||'').toLowerCase());
          if(mat){
            if(String(newT.type).toLowerCase()==='received') mat.stock += newT.qty;
            if(String(newT.type).toLowerCase()==='issued') mat.stock = Math.max(0, mat.stock - newT.qty);
            mat.product = mat.product || newT.product || mat.product;
            mat.updated = new Date().toISOString().slice(0,10);
            // Check for low stock alert
            const threshold = Number($("#defaultThreshold").value || 100);
            if(mat.stock < threshold && !alerts.some(a => a.sku === mat.sku && a.date === new Date().toISOString().slice(0,10))){
              alerts.unshift({
                sku: mat.sku,
                product: mat.product,
                qty: mat.stock,
                date: new Date().toISOString().slice(0,10)
              });
            }
          } else {
            const startingStock = String(newT.type).toLowerCase() === 'received' ? newT.qty : 0;
            const newMat = { id: Date.now()+1, product: newT.product || 'Unnamed', sku: newT.sku, category:'', description:'', qty:'', stock: startingStock, location:'', updated:new Date().toISOString().slice(0,10)};
            if(isDuplicateMaterial(newMat)){
              showToast('Duplicate material detected ‚Äî skipped', {timeout:2500});
            } else {
              materials.unshift(newMat);
              addHistory('Material', newMat.product || newMat.sku || 'Material', `Created ${newMat.product} (${newMat.sku}) from transaction`, newMat.sku);
            }
          }
          if(isDuplicateTransaction(newT)){
            showToast('Duplicate transaction detected ‚Äî skipped', {timeout:2500});
          } else {
            transactions.unshift(newT);
            addHistory('Transaction', newT.product || newT.sku || 'Transaction', `${newT.type} ${newT.qty} x ${newT.sku} (${newT.product})`, newT.sku);
          }
          saveState();
          refreshAll();
          closeModal();
          showToast('Transaction saved', {timeout:2500});
        }catch(err){ console.error('Failed to save transaction (modal)', err); showToast('Failed to save transaction'); }
      }, {once:true});
    }

    // inline form wiring (SKU -> product autofill)
    const inlineSKU = $('#inline_txnSKU');
    const inlineProdSel = $('#inline_txnProductSelect');
    if(inlineSKU && inlineProdSel){
        // SKU -> product (existing behavior)
        inlineSKU.addEventListener('input', ()=>{
          const found = findMaterialBySKU(inlineSKU.value.trim());
          if(found) {
            // find matching product in library and select it if possible, else add temporarily
            const idx = productLibrary.findIndex(p => String(p).toLowerCase() === String(found.product).toLowerCase());
            if(idx !== -1) { inlineProdSel.value = productLibrary[idx]; }
            else { // add option temporarily
              const tmpOpt = document.createElement('option'); tmpOpt.value = found.product; tmpOpt.textContent = found.product; inlineProdSel.appendChild(tmpOpt); inlineProdSel.value = found.product; }
          }
        });

        // product -> SKU (new behavior) ‚Äî when user picks an Item description, autofill Item No if known
        inlineProdSel.addEventListener('change', ()=>{
          const val = inlineProdSel.value;
          if(val && val !== '__other__' && productSKUMap[val]){
            inlineSKU.value = productSKUMap[val];
          }
        });
      }

    $('#inlineCancelTxn')?.addEventListener('click', ()=>{ $('#inlineTxn').style.display='none'; });
    // wire product library options into the inline select
    if($('#inline_txnProductSelect')){ const s = $('#inline_txnProductSelect'); s.innerHTML = productLibrary.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join(''); }
    $('#inlineSaveTxn')?.addEventListener('click', ()=>{
      try{
        const newT = {
          id: Date.now(),
          date: $('#inline_txnDate').value,
          type: $('#inline_txnType').value,
          sku: $('#inline_txnSKU').value.trim(),
          product: $('#inline_txnProductSelect') ? ($('#inline_txnProductSelect').value||'').trim() : ($('#inline_txnProduct').value||'').trim(),
          qty: Math.max(0, Number($('#inline_txnQty').value)),
          by: $('#inline_txnBy').value.trim() || 'User',
          cost: Number($('#inline_txnCost').value) || 0
        };
        if(!newT.sku){
          if(newT.product && newT.product.trim()){
            newT.sku = (newT.product.trim().toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,6) || 'SKU') + Date.now().toString().slice(-4);
          } else { alert('Please provide SKU or Product name'); return; }
        }
        const mat = materials.find(m => (m.sku||'').toLowerCase() === (newT.sku||'').toLowerCase());
        if(mat){
          if(String(newT.type).toLowerCase()==='received') mat.stock += newT.qty;
          if(String(newT.type).toLowerCase()==='issued') mat.stock = Math.max(0, mat.stock - newT.qty);
          mat.product = mat.product || newT.product || mat.product;
          mat.updated = new Date().toISOString().slice(0,10);
          mat.cost = newT.cost;
          // Check for low stock alert
          const threshold = Number($("#defaultThreshold").value || 100);
          if(mat.stock < threshold && !alerts.some(a => a.sku === mat.sku && a.date === new Date().toISOString().slice(0,10))){
            alerts.unshift({
              sku: mat.sku,
              product: mat.product,
              qty: mat.stock,
              date: new Date().toISOString().slice(0,10)
            });
          }
        } else {
          const startingStock = String(newT.type).toLowerCase() === 'received' ? newT.qty : 0;
          const newMat = { id: Date.now()+1, product: newT.product || 'Unnamed', sku: newT.sku, category:'', description:'', qty:'', stock: startingStock, location:'', updated:new Date().toISOString().slice(0,10), cost: newT.cost };
          if(isDuplicateMaterial(newMat)){
            showToast('Duplicate material detected ‚Äî skipped', {timeout:2500});
          } else {
            if(isDuplicateMaterial(newMat)){
              showToast('Duplicate material detected ‚Äî skipped', {timeout:2500});
            } else {
              materials.unshift(newMat);
            }
            addHistory('Material', newMat.product || newMat.sku || 'Material', `Created ${newMat.product} (${newMat.sku}) from transaction`, newMat.sku);
          }
        }
        if(isDuplicateTransaction(newT)){
          showToast('Duplicate transaction detected ‚Äî skipped', {timeout:2500});
        } else {
          transactions.unshift(newT);
          addHistory('Transaction', newT.product || newT.sku || 'Transaction', `${newT.type} ${newT.qty} x ${newT.sku} (${newT.product})`, newT.sku);
        }
        saveState();
        refreshAll();
        if(currentViewingMaterialSKU && currentViewingMaterialSKU.toLowerCase() === (newT.sku||'').toLowerCase()) renderMaterialModalTransactions(currentViewingMaterialSKU);
        $('#inlineTxn').style.display='none';
        showToast('Transaction saved', {timeout:2500});
      } catch(err){ console.error('Failed to save inline transaction', err); showToast('Failed to save transaction'); }
    });

    // Type change to toggle cost readonly
    $('#inline_txnType')?.addEventListener('change', () => {
      const isReceived = $('#inline_txnType').value === 'Received';
      $('#inline_txnCost').readOnly = !isReceived;
    });
    // Set initial
    if($('#inline_txnType')) {
      const isReceived = $('#inline_txnType').value === 'Received';
      $('#inline_txnCost').readOnly = !isReceived;
    }

    // Edit transaction modal
    // Inline edit: replace a transaction row with inputs so edits happen in-place
    function startInlineEditTransaction(txId, clickedEl){
      const txIndex = transactions.findIndex(t => t.id === txId);
      if(txIndex === -1) return;
      const tx = transactions[txIndex];
      // find the row in DOM to replace ‚Äî support material modal and transactions lists
      let row = null;
      if(clickedEl && clickedEl.closest) row = clickedEl.closest('tr');
      if(!row){
        // try to find any matching row by data-id in transactions tables
        row = document.querySelector(`tr button.edit-transaction[data-id="${txId}"]`)?.closest('tr');
      }
      if(!row) return;

      // backup original HTML so we can restore on cancel
      const originalHtml = row.innerHTML;

      // Create inline editor cells ‚Äî order: Type, By, Item No., Item description, QTY, Cost, Date, Actions
      row.innerHTML = `
        <td>
          <select class="input inline-e-type"><option ${tx.type==='Received'?'selected':''}>Received</option><option ${tx.type==='Issued'?'selected':''}>Issued</option><option ${tx.type==='Adjustment'?'selected':''}>Adjustment</option></select>
        </td>
        <td><input class="input inline-e-by" value="${escapeHtml(tx.by||'')}" /></td>
        <td><input class="input inline-e-sku" value="${escapeHtml(tx.sku||'')}" /></td>
        <td>
          <select class="inline-e-select input">${productLibrary.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('')}<option value="__other__">Other...</option></select>
          <input class="input inline-e-product" style="display:none;margin-top:6px" value="${escapeHtml(tx.product||'')}" />
        </td>
        <td><input class="input inline-e-qty" type="number" value="${tx.qty}" style="width:64px;text-align:right" /></td>
        <td><input class="input inline-e-cost" type="number" step="0.01" value="${skuCostMap[tx.sku] !== undefined ? skuCostMap[tx.sku] : ''}" style="width:64px;text-align:right" /></td>
        <td><input class="input inline-e-date" type="date" value="${escapeHtml(tx.date||new Date().toISOString().slice(0,10))}" /></td>
        <td style="text-align:right"><div class="actions"><button class="small btn" data-action="save-inline">Save</button><button class="small btn ghost" data-action="cancel-inline">Cancel</button></div></td>
      `;

      // Toggle cost readonly based on type
      const typeSelect = row.querySelector('.inline-e-type');
      const costInput = row.querySelector('.inline-e-cost');
      const toggleCost = () => {
        const isReceived = typeSelect.value === 'Received';
        costInput.readOnly = !isReceived;
      };
      typeSelect.addEventListener('change', toggleCost);
      toggleCost(); // initial

      // wire up SKU -> product autofill
      const skuInput = row.querySelector('.inline-e-sku');
      const prodInput = row.querySelector('.inline-e-product');
      const prodSelect = row.querySelector('.inline-e-select');
      // if the current product matches a library option, select it, otherwise show the 'other' input
      if(prodSelect){
        const foundIdx = Array.from(prodSelect.options).findIndex(o => (o.value||'') === (prodInput.value||''));
        if(foundIdx !== -1){ prodSelect.value = prodInput.value; prodInput.style.display='none'; }
        else { prodSelect.value = '__other__'; prodInput.style.display='block'; }
        prodSelect.addEventListener('change', ()=>{
          if(prodSelect.value === '__other__'){
            prodInput.style.display='block'; prodInput.value='';
          } else {
            prodInput.style.display='none'; prodInput.value = prodSelect.value;
            // when selecting a product while editing inline, autofill SKU if mapping exists
            try{ if(prodSelect.value && productSKUMap[prodSelect.value] && skuInput) skuInput.value = productSKUMap[prodSelect.value]; }catch(e){}
            // autofill cost
            const costInput = row.querySelector('.inline-e-cost');
            if(costInput) costInput.value = skuCostMap[skuInput.value] || '';
          }
        });
      }
      if(skuInput && prodInput){
        skuInput.addEventListener('input', ()=>{
          const found = findMaterialBySKU(skuInput.value.trim());
          if(found) prodInput.value = found.product;
          // autofill cost
          const costInput = row.querySelector('.inline-e-cost');
          if(costInput) costInput.value = skuCostMap[skuInput.value.trim()] || '';
        });
      }

      // Save handler
      row.querySelector('button[data-action="save-inline"]')?.addEventListener('click', ()=>{
        try{
          const updated = {
            id: tx.id,
            date: row.querySelector('.inline-e-date').value,
            type: row.querySelector('.inline-e-type').value,
            sku: row.querySelector('.inline-e-sku').value.trim(),
            product: (row.querySelector('.inline-e-select') && row.querySelector('.inline-e-select').value !== '__other__') ? row.querySelector('.inline-e-select').value.trim() : row.querySelector('.inline-e-product').value.trim(),
            qty: Math.max(0, Number(row.querySelector('.inline-e-qty').value || 0)),
            by: row.querySelector('.inline-e-by').value.trim() || tx.by || 'User'
          };

          // rollback original effect
          const orig = tx;
          const origMat = findMaterialBySKU(orig.sku);
          if(origMat){
            if(String(orig.type).toLowerCase() === 'received') origMat.stock = Math.max(0, origMat.stock - (Number(orig.qty) || 0));
            else if(String(orig.type).toLowerCase() === 'issued') origMat.stock = (origMat.stock || 0) + (Number(orig.qty) || 0);
            origMat.updated = new Date().toISOString().slice(0,10);
          }

          // apply updated (create material if missing)
          let newMat = findMaterialBySKU(updated.sku);
          if(!newMat){
            const startingStock = String(updated.type).toLowerCase() === 'received' ? updated.qty : 0;
            newMat = { id: Date.now()+1, product: updated.product || 'Unnamed', sku: updated.sku, category:'', description:'', qty:'', stock: startingStock, location:'', updated:new Date().toISOString().slice(0,10) };
            materials.unshift(newMat);
            saveState();
            addHistory('Material', newMat.product || newMat.sku || 'Material', `Created ${newMat.product} (${newMat.sku}) while editing transaction.`, newMat.sku);
          }
          if(newMat){
            if(String(updated.type).toLowerCase() === 'received') newMat.stock = (newMat.stock || 0) + (Number(updated.qty) || 0);
            else if(String(updated.type).toLowerCase() === 'issued') newMat.stock = Math.max(0, (newMat.stock || 0) - (Number(updated.qty) || 0));
            newMat.updated = new Date().toISOString().slice(0,10);
          }

          // commit
          transactions[txIndex] = updated;
          addHistory('Transaction', updated.product || updated.sku || 'Transaction', `Edited ${updated.type} ${updated.qty} x ${updated.sku} (${updated.product})`, updated.sku);
          saveState();
          refreshAll();
        } catch(e){ console.error('Inline edit save failed', e); showToast('Failed to save edit'); }
      }, {once:true});

      // Cancel handler ‚Äî restore original row
      row.querySelector('button[data-action="cancel-inline"]')?.addEventListener('click', ()=>{
        row.innerHTML = originalHtml;
      }, {once:true});
    }

    function openEditTransactionModal(existing){
      const reopenMaterialViewOnEdit = currentViewingMaterialSKU && existing && String(currentViewingMaterialSKU).toLowerCase() === String(existing.sku).toLowerCase();
      if(!existing) return;
      openModal(`
        <h3>Edit Transaction</h3>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
          <label>Type<select class="input" id="eTxnType"><option ${existing.type==='Received'?'selected':''}>Received</option><option ${existing.type==='Issued'?'selected':''}>Issued</option><option ${existing.type==='Adjustment'?'selected':''}>Adjustment</option></select></label>
          <label>By<input class="input" id="eTxnBy" placeholder="Performed by" value="${escapeHtml(existing.by||'')}" /></label>
          <label>SKU<input class="input" id="eTxnSKU" placeholder="SKU" value="${escapeHtml(existing.sku)}" /></label>
          <label>Product
            <div style="display:flex;flex-direction:column;gap:6px">
              <select id="eTxnProductSelect" class="input">${productLibrary.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('')}<option value="__other__">Other...</option></select>
              <input class="input" id="eTxnProduct" placeholder="Product" value="${escapeHtml(existing.product)}" style="display:none" />
            </div>
          </label>
          <label>Quantity<input class="input" id="eTxnQty" type="number" placeholder="Quantity" value="${existing.qty}" /></label>
          <label>Date<input class="input" id="eTxnDate" type="date" value="${escapeHtml(existing.date)}" /></label>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn ghost" id="cancelEditTxn">Cancel</button>
            <button class="btn" id="saveEditTxn">Save Changes</button>
          </div>
        </div>
      `);

      // auto-fill product when typing a known SKU
      const eSku = $("#eTxnSKU");
      const eProd = $("#eTxnProduct");
      const eSelect = $("#eTxnProductSelect");
      if(eSelect){
        // set existing selection or switch to Other
        const existingVal = `${escapeHtml(existing.product)}`;
        const found = Array.from(eSelect.options).some(o => o.value === existingVal);
        if(found){ eSelect.value = existingVal; eProd.style.display = 'none'; }
        else { eSelect.value = '__other__'; eProd.style.display = 'block'; }
        eSelect.addEventListener('change', ()=>{ 
          if(eSelect.value === '__other__'){ 
            eProd.style.display='block'; 
          } else { 
            eProd.style.display='none'; eProd.value = eSelect.value; 
            // autofill SKU when selecting a product in the edit modal
            try{ if(eSelect.value && productSKUMap[eSelect.value] && eSku) eSku.value = productSKUMap[eSelect.value]; } catch(e){}
          } 
        });
      }
      if(eSku && eProd){
        eSku.addEventListener('input', ()=>{
          const found = findMaterialBySKU(eSku.value.trim());
          if(found) eProd.value = found.product;
        });
      }

      $("#cancelEditTxn").addEventListener('click', closeModal, {once:true});
      $("#saveEditTxn").addEventListener('click', ()=>{
        const updated = {
          id: existing.id,
          date: $("#eTxnDate").value,
          type: $("#eTxnType").value,
          sku: $("#eTxnSKU").value.trim(),
          product: ($('#eTxnProductSelect') && $('#eTxnProductSelect').value !== '__other__') ? ($('#eTxnProductSelect').value || '').trim() : ($('#eTxnProduct').value || '').trim(),
          qty: Math.max(0, Number($("#eTxnQty").value || 0)),
          by: $("#eTxnBy").value.trim() || existing.by || 'User'
        };

        // find original transaction and rollback its effect on materials
        const idx = transactions.findIndex(t => t.id === existing.id);
        if(idx === -1){ alert('Original transaction not found'); closeModal(); return; }
        const orig = transactions[idx];

        // rollback original
        const origMat = findMaterialBySKU(orig.sku);
        if(origMat){
          if(String(orig.type).toLowerCase() === 'received'){
            origMat.stock = Math.max(0, origMat.stock - (Number(orig.qty) || 0));
          } else if(String(orig.type).toLowerCase() === 'issued'){
            origMat.stock = (origMat.stock || 0) + (Number(orig.qty) || 0);
          }
          origMat.updated = new Date().toISOString().slice(0,10);
        }

        // apply updated (if material exists, update; otherwise create new material so Material Records stays in sync)
        let newMat = findMaterialBySKU(updated.sku);
        if(!newMat){
          // create new material record if sku is unknown
          const startingStock = String(updated.type).toLowerCase() === 'received' ? updated.qty : 0;
          newMat = {
            id: Date.now() + 1,
            product: updated.product || 'Unnamed',
            sku: updated.sku,
            category: '',
            description: '',
            qty: '',
            stock: startingStock,
            location: '',
            updated: new Date().toISOString().slice(0,10)
          };
          materials.unshift(newMat);
          saveState();
          addHistory('Material', newMat.product || newMat.sku || 'Material', `Created ${newMat.product} (${newMat.sku}) while editing transaction.`, newMat.sku);
          alert(`Created new material record for SKU ${newMat.sku} while editing transaction.`);
        }
        if(newMat){
          if(String(updated.type).toLowerCase() === 'received'){
            newMat.stock = (newMat.stock || 0) + (Number(updated.qty) || 0);
          } else if(String(updated.type).toLowerCase() === 'issued'){
            newMat.stock = Math.max(0, (newMat.stock || 0) - (Number(updated.qty) || 0));
          }
          newMat.updated = new Date().toISOString().slice(0,10);
        }

        // write back
        transactions[idx] = updated;
        addHistory('Transaction', updated.product || updated.sku || 'Transaction', `Edited ${updated.type} ${updated.qty} x ${updated.sku} (${updated.product})`, updated.sku);
        saveState();
        refreshAll();
        closeModal();
        // if we opened the edit modal from within a material view modal, reopen the material view so user returns to context
        if(reopenMaterialViewOnEdit){
          const mat = findMaterialBySKU(updated.sku || existing.sku);
          if(mat) setTimeout(()=> openMaterialView(mat), 100);
        }
      }, {once:true});
    }

    // Reporting defects
    $("#reportDefectBtn")?.addEventListener('click', ()=>{
      openModal(`
        <h3>Log Defect</h3>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
          <label>Type<input class="input" id="defType" placeholder="Defect type"/></label>
          <label>By<input class="input" id="defBy" placeholder="Reported by"/></label>
          <label>Item No.<input class="input" id="defSKU" placeholder="SKU"/></label>
          <label>Item description<select id="defProductSelect" class="input"></select></label>
          <label>QTY<input class="input" id="defQty" type="number" value="1"/></label>
          <label>Note<input class="input" id="defNote" placeholder="Additional note"/></label>
          <label>Date<input class="input" id="defDate" type="date" value="${new Date().toISOString().slice(0,10)}"/></label>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn ghost" id="cancelDef">Cancel</button>
            <button class="btn" id="saveDef">Save</button>
          </div>
        </div>
      `);
      // populate product select
      const defSelect = $('#defProductSelect');
      if(defSelect){
        defSelect.innerHTML = productLibrary.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');
      }

      // wire product select -> SKU autofill
      if(defSelect){
        defSelect.addEventListener('change', ()=>{
          const selectedProduct = defSelect.value;
          if(productSKUMap[selectedProduct]) $("#defSKU").value = productSKUMap[selectedProduct];
        });
      }
      $("#cancelDef").addEventListener('click', closeModal);
      $("#saveDef").addEventListener('click', ()=>{
        const skuVal = $("#defSKU").value.trim();
        defects.unshift({
          type: $("#defType").value.trim() || 'Unknown',
          by: $("#defBy").value.trim() || 'User',
          sku: skuVal || '-',
          product: $("#defProductSelect").value.trim() || "Unknown",
          qty: Math.max(0, Number($("#defQty").value)),
          note: $("#defNote").value.trim() || '',
          date: $("#defDate").value,
          status: "Open"
        });
        const defProductTitle = $("#defProductSelect").value.trim() || skuVal || '-';
        addHistory('Defect', defProductTitle, `${$("#defType").value || 'Unknown'} on ${skuVal || '-' }`, skuVal || '-');
        saveState();
        refreshAll();
        closeModal();
      });
    });

    // search
    $("#globalSearch").addEventListener('input', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      if(!q){ refreshAll(); return; }
      const mFiltered = materials.filter(m => (m.product+m.sku+m.category+(m.description||'')).toLowerCase().includes(q));
      buildMaterialsTable($("#materialsTable"), mFiltered);
      buildMaterialsTable($("#materialsTable2"), mFiltered);
      const tFiltered = transactions.filter(t => (t.product+t.sku+t.type).toLowerCase().includes(q));
      const tbodyT = $("#transactionsTable tbody");
      tbodyT.innerHTML="";
      tFiltered.forEach(t=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(t.type)}</td>
          <td>${escapeHtml(t.by || '')}</td>
          <td>${escapeHtml(t.sku)}</td>
          <td>${escapeHtml(t.product)}</td>
            <td>${t.qty}</td>
            <td>${t.date}</td>
          <td style="text-align:right"><div class="actions"><button class="small btn ghost edit-transaction" data-id="${t.id}">Edit</button><button class="small btn ghost delete-transaction" data-id="${t.id}">Delete</button></div></td>
        `;
        tbodyT.appendChild(tr);
      });
      // also update the full transactions table view for results
      const tbodyFull = $("#transactionsTableFull tbody");
      if(tbodyFull){
        tbodyFull.innerHTML = "";
          tFiltered.forEach(t=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `\
            <td>${escapeHtml(t.type)}</td>\
            <td>${escapeHtml(t.by||'')}</td>\
            <td>${escapeHtml(t.sku)}</td>\
            <td>${escapeHtml(t.product)}</td>\
            <td>${t.qty}</td>
            <td>${t.date}</td>\
            <td style="text-align:right"><div class="actions"><button class="small btn ghost edit-transaction" data-id="${t.id}">Edit</button><button class="small btn ghost delete-transaction" data-id="${t.id}">Delete</button></div></td>\
          `;
          tbodyFull.appendChild(tr);
        });
      }
      const dFiltered = defects.filter(d => (d.product+d.sku+d.type).toLowerCase().includes(q));
      const tbodyD = $("#defectsTable tbody");
      tbodyD.innerHTML="";
      dFiltered.forEach(d=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${d.date}</td><td>${escapeHtml(d.product)}</td><td>${escapeHtml(d.sku)}</td><td>${escapeHtml(d.type)}</td><td><span class="badge ${d.status==='Open'?'red':'green'}">${d.status}</span></td><td></td>`;
        tbodyD.appendChild(tr);
      });
    });

    // export CSV (materials)
    $("#exportBtn").addEventListener('click', ()=>{
      const rows = [["Product","SKU","Category","Stock","Location","Updated"], ...materials.map(m=>[m.product,m.sku,m.category,m.stock,m.location,m.updated])];
      const csv = rows.map(r => r.map(v => `"${String(v === null || v === undefined ? '' : String(v)).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'materials.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // settings save (demo)
    $("#saveSettings")?.addEventListener('click', ()=>{
      const alertsEnabled = $("#toggleAlerts").checked;
      const autoReorder = $("#toggleReorder").checked;
      const threshold = Number($("#defaultThreshold").value);
      refreshAll();
      alert(`Settings saved (demo): Alerts: ${alertsEnabled}, AutoReorder: ${autoReorder}, Threshold: ${threshold}`);
    });

    // User Management System
    let registeredUsers = JSON.parse(localStorage.getItem('registeredUsers')) || [];

    // Load registered users on page load
    function loadRegisteredUsers() {
      const tbody = document.getElementById('usersTableBody');
      if (registeredUsers.length === 0) {
        tbody.innerHTML = '<tr style="border-bottom:1px solid var(--input-border)"><td colspan="5" style="padding:20px;text-align:center;color:var(--muted)">No registered users yet. Add users to manage access.</td></tr>';
        return;
      }

      tbody.innerHTML = registeredUsers.map((user, idx) => `
        <tr style="border-bottom:1px solid var(--input-border)">
          <td style="padding:10px;font-size:13px;font-weight:600">${user.username}</td>
          <td style="padding:10px;font-size:13px">${user.email}</td>
          <td style="padding:10px;font-size:13px">
            <span class="badge ${user.role === 'admin' ? 'red' : user.role === 'employee' ? 'orange' : 'green'}" style="text-transform:capitalize">${user.role}</span>
          </td>
          <td style="padding:10px;font-size:13px">
            <select id="roleSelect_${idx}" style="padding:4px 6px;border-radius:4px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);cursor:pointer;font-size:12px">
              <option value="student" ${user.role === 'student' ? 'selected' : ''}>Student</option>
              <option value="employee" ${user.role === 'employee' ? 'selected' : ''}>Employee</option>
              <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
            </select>
          </td>
          <td style="padding:10px;text-align:center">
            <button class="btn ghost small" onclick="updateUserRole(${idx})" style="padding:4px 8px;font-size:11px;margin-right:4px">Update</button>
            <button class="btn ghost small" onclick="deleteUser(${idx})" style="padding:4px 8px;font-size:11px;background:rgba(239, 68, 68, 0.1);color:var(--danger)">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    // Add new user
    document.getElementById('addUserBtn').addEventListener('click', () => {
      const username = document.getElementById('newUsername').value.trim();
      const email = document.getElementById('newEmail').value.trim();
      const role = document.getElementById('newUserRole').value;

      if (!username || !email) {
        alert('Error: Please fill in all fields');
        return;
      }

      if (!email.includes('@')) {
        alert('Error: Please enter a valid email');
        return;
      }

      if (registeredUsers.some(u => u.email.toLowerCase() === email.toLowerCase())) {
        alert('Error: Email already registered');
        return;
      }

      const newUser = {
        username,
        email,
        role,
        createdAt: new Date().toISOString()
      };

      registeredUsers.push(newUser);
      localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
      
      // Clear form
      document.getElementById('newUsername').value = '';
      document.getElementById('newEmail').value = '';
      document.getElementById('newUserRole').value = 'student';

      loadRegisteredUsers();
      alert(`Success: User '${username}' added successfully`);
    });

    // Update user role
    window.updateUserRole = function(idx) {
      const roleSelect = document.getElementById(`roleSelect_${idx}`);
      const newRole = roleSelect.value;
      const oldRole = registeredUsers[idx].role;
      
      registeredUsers[idx].role = newRole;
      localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
      
      loadRegisteredUsers();
      alert(`Success: User role updated from ${oldRole} to ${newRole}`);
    };

    // Delete user
    window.deleteUser = function(idx) {
      if (confirm(`Are you sure you want to delete user '${registeredUsers[idx].username}'?`)) {
        const username = registeredUsers[idx].username;
        registeredUsers.splice(idx, 1);
        localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
        
        loadRegisteredUsers();
        alert(`Success: User '${username}' has been deleted`);
      }
    };

    // Load users when settings page is opened
    const originalPageLoad = window.showPage || function(){};
    window.showPage = function(pageId) {
      if (pageId === 'settings') {
        loadRegisteredUsers();
      }
      originalPageLoad(pageId);
    };

    // Initial load of users
    loadRegisteredUsers();

    // initial feathers icons replacement (after DOM content)
    function replaceFeatherIcons(){
      if(window.feather) feather.replace();
    }

    // Update material costs based on the latest transaction cost for each SKU
    function updateMaterialCostsFromTransactions() {
      materials.forEach(mat => {
        const skuTransactions = transactions.filter(t => String(t.sku).toLowerCase() === String(mat.sku).toLowerCase() && t.cost !== undefined && t.cost !== null);
        if (skuTransactions.length > 0) {
          // Sort by date descending to get the latest
          skuTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
          mat.cost = skuTransactions[0].cost;
        } else if (skuCostMap[mat.sku]) {
          mat.cost = skuCostMap[mat.sku];
        }
      });
    }

    // --- Refresh function to update all live data views ---
    function refreshAll() {
      // Update material costs from transactions
      updateMaterialCostsFromTransactions();
      // ensure product selects are up-to-date
      updateProductSelects();
      // Rebuild main tables
      buildMaterialsTableMain();
      buildMaterialsTable2();
      buildTransactions(true);
      buildComparisonTables();
      
      // For transactions page, use current filters
      const currentPage = Object.keys(pages).find(key => pages[key].style.display !== 'none');
      if (currentPage === 'transactions') {
        const searchTerm = $("#transactionsSearch")?.value.trim() || '';
        const typeFilter = $("#transactionsTypeFilter")?.value || '';
        const dateFilter = $("#transactionsDateFilter")?.value || '';
        buildTransactions(false, searchTerm, typeFilter, dateFilter);
      } else {
        buildTransactions(false);
      }
      
      // For defects page, use current filters
      if (currentPage === 'defects') {
        const searchTerm = $("#defectsSearch")?.value.trim() || '';
        const dateFilter = $("#defectsDateFilter")?.value || '';
        buildDefectsTable(searchTerm, '', dateFilter);
      } else {
        buildDefectsTable();
      }
      
      // For materials page, use current search
      if (currentPage === 'materials') {
        const searchTerm = $("#materialsSearch")?.value.trim() || '';
        buildMaterialsTable2(searchTerm);
      }
      
      buildAlertsList();

      // Update dashboard summary cards
      const filterProduct = $("#totalMaterialsFilter").value;
      $("#materialsReceived").textContent = computeTotalAvailable(filterProduct);
      $("#defectsCount").textContent = computeDefectsCount30d();

      // Re-render charts
      renderDefectsChart();

      // Update demand tracking if on linear programming page
      if (currentPage === 'linear-programming' && typeof calculateDemandTracking === 'function') {
        calculateDemandTracking();
      }

      // Update stock counts
      const threshold = Number($("#defaultThreshold").value || 100);
      const lowStock = materials.filter(m => m.stock < threshold && m.stock > 0).length;
      const outStock = materials.filter(m => m.stock === 0).length;

      $("#lowStockCount").textContent = lowStock;
      $("#oosCount").textContent = outStock;
      
      replaceFeatherIcons();
      // update user button visibility after refresh
      updateUserButton();
    }

    // --- Initial page render ---
    initAddMaterialButtons();
    refreshAll();

    // Replace feather icons after UI render
    feather.replace();

    // --- Demand Tracking & Bill of Materials Functions ---
    function buildBillOfMaterialsTable() {
      const tbody = $("#billOfMaterialsTbody");
      if (!tbody) return;
      
      tbody.innerHTML = '';
      
      billOfMaterials.forEach(bom => {
        // Get the material record to find issued quantity
        const material = materials.find(m => String(m.sku).toLowerCase() === String(bom.sku).toLowerCase());
        
        // Calculate quantities based on target demand
        const targetDemand = parseInt(document.getElementById("targetDemandInput").value) || 0;
        const totalRequired = targetDemand * bom.qtyPerUnit;
        
        // Get issued quantity from transactions
        const issuedQty = transactions
          .filter(t => t.type === 'Issued' && String(t.sku).toLowerCase() === String(bom.sku).toLowerCase())
          .reduce((sum, t) => sum + (t.qty || 0), 0);
        
        const available = material ? material.stock : 0;
        
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid var(--input-border)';
        row.innerHTML = `
          <td style="padding:10px;font-size:13px">${bom.itemNo}</td>
          <td style="padding:10px;font-size:13px">${bom.description}</td>
          <td style="padding:10px;font-size:13px;font-weight:600">${bom.qtyPerUnit}</td>
          <td style="padding:10px;font-size:13px;font-weight:600">${totalRequired}</td>
          <td style="padding:10px;font-size:13px;font-weight:600;color:var(--accent)">${issuedQty}</td>
          <td style="padding:10px;font-size:13px;color:${available >= totalRequired ? 'var(--success)' : 'var(--danger)'}">${available}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function calculateDemandTracking() {
      const targetDemand = parseInt(document.getElementById("targetDemandInput").value) || 0;
      
      // Display target demand
      document.getElementById("displayTargetDemand").textContent = targetDemand;
      document.getElementById("totalDemandNeeded").textContent = targetDemand;
      
      // Calculate units produced based on bottleneck method
      // For each material: unitsPossible = floor(issuedQty / qtyPerUnit)
      // The material with the LOWEST unitsPossible is the bottleneck
      let minUnitsProduced = Infinity;
      let insufficientMaterials = [];
      
      billOfMaterials.forEach(bom => {
        // Get issued quantity from transactions for this material
        const issuedQty = transactions
          .filter(t => t.type === 'Issued' && String(t.sku).toLowerCase() === String(bom.sku).toLowerCase())
          .reduce((sum, t) => sum + (t.qty || 0), 0);
        
        // How many complete units can be made with this material?
        const unitsFromThisMaterial = Math.floor(issuedQty / bom.qtyPerUnit);
        
        // Track the bottleneck
        if (unitsFromThisMaterial < minUnitsProduced) {
          minUnitsProduced = unitsFromThisMaterial;
        }
        
        // Track insufficient materials (those that can't produce even 1 unit)
        if (unitsFromThisMaterial < 1) {
          const shortage = bom.qtyPerUnit - issuedQty;
          insufficientMaterials.push({
            description: bom.description,
            required: bom.qtyPerUnit,
            issued: issuedQty,
            shortage: shortage
          });
        }
      });
      
      // If no materials, units produced = 0
      const unitProduced = minUnitsProduced === Infinity ? 0 : minUnitsProduced;
      

      // Calculate remaining demand
      const remainingDemand = Math.max(0, targetDemand - unitProduced);
      
      // Update display
      document.getElementById("unitProduced").textContent = unitProduced;
      document.getElementById("remainingDemand").textContent = remainingDemand;
      
      // Update demand status badge
      const statusBadge = document.getElementById("demandStatusBadge");
      if (remainingDemand === 0 && targetDemand > 0) {
        // Demand is met
        statusBadge.className = 'badge green';
        statusBadge.textContent = '‚úÖ Met';
      } else if (insufficientMaterials.length > 0) {
        // Cannot be met - insufficient materials
        statusBadge.className = 'badge red';
        statusBadge.textContent = '‚ùå Cannot Be Met';
      } else if (remainingDemand > 0) {
        // Not yet met
        statusBadge.className = 'badge orange';
        statusBadge.textContent = '‚è≥ Not Met';
      } else {
        // No target demand set
        statusBadge.className = 'badge gray';
        statusBadge.textContent = 'Pending';
      }
      
      // Show/hide insufficient materials alert
      const insufficientAlert = document.getElementById("insufficientMaterialsAlert");
      const sufficientAlert = document.getElementById("sufficientMaterialsAlert");
      
      if (insufficientMaterials.length > 0) {
        insufficientAlert.style.display = 'block';
        sufficientAlert.style.display = 'none';
        
        let html = '';
        insufficientMaterials.forEach((material, idx) => {
          html += `<div style="margin-bottom:8px;padding:8px;background:rgba(239, 68, 68, 0.1);border-radius:4px">
            <strong>${material.description}</strong><br>
            Required: ${material.required} | Issued: ${material.issued} | <span style="color:var(--danger);font-weight:600">Missing: ${material.shortage}</span>
          </div>`;
        });
        document.getElementById("insufficientMaterialsList").innerHTML = html;
      } else {
        insufficientAlert.style.display = 'none';
        sufficientAlert.style.display = 'block';
        sufficientAlert.querySelector('h4').textContent = `‚úÖ ${unitProduced} Unit${unitProduced !== 1 ? 's' : ''} Ready to Produce`;
      }
      
      // Show/hide demand met indicator
      const demandMetAlert = document.getElementById("demandMetAlert");
      const demandUnmetAlert = document.getElementById("demandUnmetAlert");
      
      if (unitProduced >= targetDemand && targetDemand > 0) {
        demandMetAlert.style.display = 'block';
        demandUnmetAlert.style.display = 'none';
        document.getElementById("demandMetTargetDisplay").textContent = targetDemand;
        document.getElementById("demandMetProducedDisplay").textContent = unitProduced;
      } else if (targetDemand > 0) {
        demandMetAlert.style.display = 'none';
        demandUnmetAlert.style.display = 'block';
        document.getElementById("demandUnmetTargetDisplay").textContent = targetDemand;
        document.getElementById("demandUnmetProducedDisplay").textContent = unitProduced;
        document.getElementById("demandStillNeeded").textContent = targetDemand - unitProduced;
      } else {
        demandMetAlert.style.display = 'none';
        demandUnmetAlert.style.display = 'none';
      }
      
      // Sync Total Demand (D) with Target Demand
      document.getElementById("demandInput").value = targetDemand;
      
      // Update the BOM table to reflect current state
      buildBillOfMaterialsTable();
    }

    // Save Target Demand to localStorage
    function saveTargetDemand() {
      const targetDemand = document.getElementById("targetDemandInput").value;
      try {
        localStorage.setItem('targetDemand', targetDemand);
        // Show success toast
        addToast({title: 'Success', msg: 'Target Demand saved successfully', duration: 2000});
      } catch(e) {
        console.warn('Failed to save target demand', e);
      }
    }

    // Load Target Demand from localStorage
    function loadTargetDemand() {
      try {
        const saved = localStorage.getItem('targetDemand');
        if (saved) {
          document.getElementById("targetDemandInput").value = saved;
          calculateDemandTracking();
        }
      } catch(e) {
        console.warn('Failed to load target demand', e);
      }
    }

    // Event listener for target demand input
    document.getElementById("targetDemandInput").addEventListener('change', calculateDemandTracking);
    document.getElementById("targetDemandInput").addEventListener('input', calculateDemandTracking);
    
    // Sync listener for Total Demand (D) input - when it changes, sync back to Target Demand
    document.getElementById("demandInput").addEventListener('change', function() {
      document.getElementById("targetDemandInput").value = this.value;
      calculateDemandTracking();
    });
    
    document.getElementById("demandInput").addEventListener('input', function() {
      document.getElementById("targetDemandInput").value = this.value;
      calculateDemandTracking();
    });
    
    // Save button event listener
    document.getElementById("saveTargetDemandBtn").addEventListener('click', saveTargetDemand);

    // Linear Programming calculate function
    function calculate() {
      const demand = parseInt(document.getElementById("demandInput").value);
      let remaining = demand;
      let totalCost = 0;
      let allocation = [];

      // Collect materials data from the table
      let materials = [];
      const rows = $("#lpMaterialsTbody").querySelectorAll('tr');
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const name = cells[0].textContent.trim();
        const qtyInput = cells[1].querySelector('input');
        const costInput = cells[2].querySelector('input');
        const qty = +qtyInput.value;
        const cost = +costInput.value;
        materials.push({name, qty, cost});
      });

      // Sort by lowest cost first
      materials.sort((a, b) => a.cost - b.cost);

      for (let m of materials) {
        let used = Math.min(m.qty, remaining);
        allocation.push({
          name: m.name,
          available: m.qty,
          used: used,
          variance: m.qty - used,
          cost: m.cost
        });
        totalCost += used * m.cost;
        remaining -= used;
        if (remaining <= 0) break;
      }

      // Calculate total available quantity for feasibility check
      const totalAvailable = materials.reduce((sum, m) => sum + m.qty, 0);
      const isFeasible = totalAvailable >= demand;
      const status = isFeasible ? 'Feasible' : 'Infeasible';
      const statusClass = isFeasible ? 'green' : 'red';

      // Build output
      const now = new Date();
      const timestamp = now.toLocaleTimeString();
      let html = `<h2>Allocation Results</h2><p style="font-size:12px;color:var(--muted);">Last updated: ${timestamp}</p>`;
      html += `<table><tr><th>Material</th><th>Available</th><th>Used</th><th>Variance</th><th>Cost/Unit</th><th>Status</th></tr>`;
      allocation.forEach(a => {
        html += `<tr>
          <td>${a.name}</td>
          <td>${a.available}</td>
          <td>${a.used}</td>
          <td>${a.variance}</td>
          <td>‚Ç±${a.cost}</td>
          <td><span class="badge ${statusClass}">${status}</span></td>
        </tr>`;
      });
      html += "</table>";
      html += `<p><strong>Total Cost (Z) = ‚Ç±${totalCost.toLocaleString()}</strong></p>`;
      html += `<p>Demand fully met: ${demand} units</p>`;
      html += `<p><strong>Overall Status: <span class="badge ${statusClass}">${status}</span></strong> (Total Available: ${totalAvailable} units, Demand: ${demand} units)</p>`;

      document.getElementById("output").innerHTML = html;
    }

  </script>
</body>
</html>



